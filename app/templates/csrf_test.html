{% extends "base.html" %}

{% block title %}CSRF Token Test{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h3>CSRF Token Test Panel</h3>
                </div>
                <div class="card-body">
                    <!-- Current Token Display -->
                    <div class="mb-4">
                        <h5>Current CSRF Token:</h5>
                        <div class="form-group">
                            <textarea id="currentToken" class="form-control" rows="3" readonly></textarea>
                        </div>
                        <small class="text-muted">Last updated: <span id="tokenTimestamp">Never</span></small>
                    </div>

                    <!-- Token Management Buttons -->
                    <div class="mb-4">
                        <h5>Token Management:</h5>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-primary" onclick="refreshToken()">
                                Refresh Token
                            </button>
                            <button type="button" class="btn btn-info" onclick="validateToken()">
                                Validate Token
                            </button>
                            <button type="button" class="btn btn-warning" onclick="clearToken()">
                                Clear Token
                            </button>
                        </div>
                    </div>

                    <!-- Test Form -->
                    <div class="mb-4">
                        <h5>Test Form Submission:</h5>
                        <form id="testForm" method="POST" action="/csrf-test">
                            {{ csrf_token() }}
                            <div class="form-group">
                                <label for="testData">Test Data:</label>
                                <input type="text" class="form-control" id="testData" name="test_data" 
                                       value="Sample test data" required>
                            </div>
                            <button type="submit" class="btn btn-success">Submit Test Form</button>
                        </form>
                    </div>

                    <!-- API Test -->
                    <div class="mb-4">
                        <h5>API Request Test:</h5>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-secondary" onclick="testApiGet()">
                                Test GET Request
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="testApiPost()">
                                Test POST Request
                            </button>
                        </div>
                    </div>

                    <!-- Results Display -->
                    <div class="mb-4">
                        <h5>Test Results:</h5>
                        <div id="testResults" class="border rounded p-3" style="height: 200px; overflow-y: auto; background-color: #f8f9fa;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize display
    updateTokenDisplay();
    
    // Set up form submission
    document.getElementById('testForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        try {
            const response = await window.labAPI.submitForm(this);
            const result = await response.text();
            
            addTestResult('Form Submission', response.ok ? 'SUCCESS' : 'FAILED', {
                status: response.status,
                response: result
            });
        } catch (error) {
            addTestResult('Form Submission', 'ERROR', error.message);
        }
    });
});

async function refreshToken() {
    try {
        await window.labAPI.refreshCSRFToken(true);
        updateTokenDisplay();
        addTestResult('Token Refresh', 'SUCCESS', 'Token refreshed successfully');
    } catch (error) {
        addTestResult('Token Refresh', 'ERROR', error.message);
    }
}

async function validateToken() {
    try {
        const response = await fetch('/api/v1/csrf-token/validate', {
            method: 'POST',
            headers: {
                'X-CSRFToken': window.labAPI.csrfToken,
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin'
        });
        
        const result = await response.json();
        addTestResult('Token Validation', response.ok ? 'SUCCESS' : 'FAILED', result);
    } catch (error) {
        addTestResult('Token Validation', 'ERROR', error.message);
    }
}

function clearToken() {
    window.labAPI.csrfToken = null;
    window.labAPI.csrfTokenTimestamp = null;
    updateTokenDisplay();
    addTestResult('Clear Token', 'SUCCESS', 'Token cleared from memory');
}

async function testApiGet() {
    try {
        const response = await window.labAPI.get('/system/health');
        const result = await response.json();
        addTestResult('API GET Test', response.ok ? 'SUCCESS' : 'FAILED', result);
    } catch (error) {
        addTestResult('API GET Test', 'ERROR', error.message);
    }
}

async function testApiPost() {
    try {
        const response = await window.labAPI.post('/csrf-token/validate', {});
        const result = await response.json();
        addTestResult('API POST Test', response.ok ? 'SUCCESS' : 'FAILED', result);
    } catch (error) {
        addTestResult('API POST Test', 'ERROR', error.message);
    }
}

function updateTokenDisplay() {
    const tokenField = document.getElementById('currentToken');
    const timestampField = document.getElementById('tokenTimestamp');
    
    if (window.labAPI && window.labAPI.csrfToken) {
        tokenField.value = window.labAPI.csrfToken;
        if (window.labAPI.csrfTokenTimestamp) {
            timestampField.textContent = new Date(window.labAPI.csrfTokenTimestamp).toLocaleString();
        }
    } else {
        tokenField.value = 'No token available';
        timestampField.textContent = 'Never';
    }
}

function addTestResult(testName, status, details) {
    const resultsDiv = document.getElementById('testResults');
    const timestamp = new Date().toLocaleTimeString();
    
    const statusClass = status === 'SUCCESS' ? 'text-success' : 
                       status === 'ERROR' ? 'text-danger' : 'text-warning';
    
    const resultHtml = `
        <div class="mb-2">
            <strong>[${timestamp}] ${testName}:</strong> 
            <span class="${statusClass}">${status}</span>
            <div class="small text-muted mt-1">
                ${typeof details === 'object' ? JSON.stringify(details, null, 2) : details}
            </div>
        </div>
    `;
    
    resultsDiv.innerHTML += resultHtml;
    resultsDiv.scrollTop = resultsDiv.scrollHeight;
}
</script>
{% endblock %}
