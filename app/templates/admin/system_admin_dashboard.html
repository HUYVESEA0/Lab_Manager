{% extends "admin/admin_base.html" %}

{% set dashboard_title = "Bảng Điều Khiển Quản Trị Hệ Thống" %}
{% set dashboard_type = "system" %}
{% set enable_realtime = true %}
{% set cache_version = "20250616001" %}
{% set use_api = true %}

{% block dashboard_content %}
<!-- Flash Messages are handled by admin_base.html -->
<div class="modern-dashboard">
    <div class="container-fluid">
        <!-- Enhanced Dashboard Hero Section -->
        <div class="dashboard-hero">
            <div class="hero-content">
                <div class="hero-text">
                    <h1 class="hero-title">
                        <i class="fas fa-tachometer-alt"></i>
                        Bảng Điều Khiển Quản Trị Hệ Thống
                    </h1>
                    <p class="hero-subtitle">Giám sát và quản lý toàn bộ hệ thống Lab Manager</p>
                </div>
                <div class="hero-actions">
                    <button class="btn btn-outline-light" onclick="refreshDashboard()">
                        <i class="fas fa-sync-alt"></i> Làm mới
                    </button>
                    <button class="btn btn-light" data-toggle="modal" data-target="#systemOperationModal">
                        <i class="fas fa-cogs"></i> Cài đặt
                    </button>
                </div>
            </div>
            <div class="hero-status">
                <div class="status-badge online">
                    <div class="status-indicator"></div>
                    <span>Hệ thống hoạt động bình thường</span>
                </div>
                <div class="last-update">
                    Cập nhật lúc: <span id="current-time"></span>
                </div>
            </div>
        </div>

        <!-- Key Metrics Overview -->
        <div class="metrics-section">
            <div class="row g-4">
                <div class="col-xl-3 col-lg-6">
                    <div class="metric-card-modern primary">
                        <div class="metric-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="metric-content">
                            <div class="metric-number" id="total-users">{{ stats.user_count or 0 }}</div>
                            <div class="metric-label">Tổng người dùng</div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-lg-6">
                    <div class="metric-card-modern success">
                        <div class="metric-icon">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="metric-content">
                            <div class="metric-number" id="active-users">{{ stats.active_users or 0 }}</div>
                            <div class="metric-label">Đang hoạt động</div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-lg-6">
                    <div class="metric-card-modern info">
                        <div class="metric-icon">
                            <i class="fas fa-flask"></i>
                        </div>
                        <div class="metric-content">
                            <div class="metric-number" id="total-labs">{{ stats.lab_session_count or 0 }}</div>
                            <div class="metric-label">Phiên Lab</div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-lg-6">
                    <div class="metric-card-modern warning">
                        <div class="metric-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="metric-content">
                            <div class="metric-number" id="system-alerts">{{ (stats.critical_alerts or 0) + (stats.warning_alerts or 0) }}</div>
                            <div class="metric-label">Cảnh Báo</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Dashboard Content -->
        <div class="dashboard-content">
            <div class="row g-4">
                <!-- System Performance Section - Modern Design -->
                <div class="col-xl-8 col-lg-12">
                    <div class="dashboard-card performance-card">
                        <div class="card-header">
                            <div class="header-content">
                                <h5 class="card-title">
                                    <i class="fas fa-chart-line"></i>
                                    Hiệu Suất Hệ Thống
                                </h5>
                                <p class="card-subtitle">Giám sát tài nguyên và hiệu suất real-time</p>
                            </div>
                            <div class="header-actions">
                                <div class="status-badge online">
                                    <i class="fas fa-circle"></i>
                                    Live
                                </div>
                                <button class="btn btn-sm btn-outline-primary" onclick="refreshPerformance()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Performance Chart -->
                            <div class="chart-container">
                                <canvas id="performanceChart" height="200"></canvas>
                            </div>
                            
                            <!-- Performance Metrics -->
                            <div class="performance-metrics">
                                <div class="metric-item">
                                    <div class="metric-icon cpu">
                                        <i class="fas fa-microchip"></i>
                                    </div>
                                    <div class="metric-details">
                                        <div class="metric-label">CPU</div>
                                        <div class="metric-value">60.7%</div>
                                        <div class="metric-bar">
                                            <div class="bar-fill" style="width: 60.7%"></div>
                                        </div>
                                        <div class="metric-status good">Normal</div>
                                    </div>
                                </div>
                                
                                <div class="metric-item">
                                    <div class="metric-icon memory">
                                        <i class="fas fa-memory"></i>
                                    </div>
                                    <div class="metric-details">
                                        <div class="metric-label">RAM</div>
                                        <div class="metric-value">78.9%</div>
                                        <div class="metric-bar">
                                            <div class="bar-fill warning" style="width: 78.9%"></div>
                                        </div>
                                        <div class="metric-status warning">High</div>
                                    </div>
                                </div>
                                
                                <div class="metric-item">
                                    <div class="metric-icon disk">
                                        <i class="fas fa-hdd"></i>
                                    </div>
                                    <div class="metric-details">
                                        <div class="metric-label">Disk</div>
                                        <div class="metric-value">53.9%</div>
                                        <div class="metric-bar">
                                            <div class="bar-fill" style="width: 53.9%"></div>
                                        </div>
                                        <div class="metric-status good">Normal</div>
                                    </div>
                                </div>
                                
                                <div class="metric-item">
                                    <div class="metric-icon network">
                                        <i class="fas fa-wifi"></i>
                                    </div>
                                    <div class="metric-details">
                                        <div class="metric-label">Network</div>
                                        <div class="metric-value">21.4%</div>
                                        <div class="metric-bar">
                                            <div class="bar-fill" style="width: 21.4%"></div>
                                        </div>
                                        <div class="metric-status good">Active</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- User Activity Section - Modern Design -->
                <div class="col-xl-4 col-lg-12">
                    <div class="dashboard-card activity-card">
                        <div class="card-header">
                            <div class="header-content">
                                <h5 class="card-title">
                                    <i class="fas fa-users"></i>
                                    Hoạt Động Người Dùng
                                </h5>
                                <p class="card-subtitle">Thống kê truy cập real-time</p>
                            </div>
                            <div class="header-actions">
                                <button class="btn btn-sm btn-outline-primary" onclick="refreshActivity()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Activity Chart -->
                            <div class="chart-container small">
                                <canvas id="userActivityChart" height="150"></canvas>
                            </div>
                            
                            <!-- Activity Stats -->
                            <div class="activity-stats">
                                <div class="stat-row">
                                    <div class="stat-icon online">
                                        <i class="fas fa-circle"></i>
                                    </div>
                                    <div class="stat-content">
                                        <div class="stat-label">Online hiện tại</div>
                                        <div class="stat-value" id="online-users">{{ stats.active_users or 0 }}</div>
                                    </div>
                                    <div class="stat-trend up">Live</div>
                                </div>
                                
                                <div class="stat-row">
                                    <div class="stat-icon login">
                                        <i class="fas fa-sign-in-alt"></i>
                                    </div>
                                    <div class="stat-content">
                                        <div class="stat-label">Đăng nhập hôm nay</div>
                                        <div class="stat-value" id="daily-logins">{{ stats.daily_logins or 0 }}</div>
                                    </div>
                                    <div class="stat-trend up">+{{ ((stats.daily_logins or 0) / (stats.user_count or 1) * 100) | round(1) }}%</div>
                                </div>
                                
                                <div class="stat-row">
                                    <div class="stat-icon session">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                    <div class="stat-content">
                                        <div class="stat-label">Phiên hoạt động</div>
                                        <div class="stat-value" id="active-sessions">{{ stats.active_sessions_today or 0 }}</div>
                                    </div>
                                    <div class="stat-trend up">Hôm nay</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>



        <!-- System Operations Section -->
        <div class="operations-section">
            <div class="row g-4">
                <div class="col-12">
                    <div class="operations-card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="fas fa-tools"></i>
                                Thao Tác Hệ Thống
                            </h5>
                            <div class="warning-badge">
                                Cẩn trọng
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <ul class="operation-list">
                                <li class="operation-item">
                                    <div class="operation-info">
                                        <div class="operation-icon backup">
                                            <i class="fas fa-download"></i>
                                        </div>
                                        <div class="operation-details">
                                            <h6>Sao lưu dữ liệu</h6>
                                            <p>Tạo bản sao lưu đầy đủ hệ thống và cơ sở dữ liệu</p>
                                        </div>
                                    </div>
                                    <div class="operation-actions">
                                        <button type="button" class="operation-btn btn-primary" disabled>
                                            <i class="fas fa-download"></i> Sao lưu
                                        </button>
                                    </div>
                                </li>
                                
                                <li class="operation-item">
                                    <div class="operation-info">
                                        <div class="operation-icon reset">
                                            <i class="fas fa-database"></i>
                                        </div>
                                        <div class="operation-details">
                                            <h6>Đặt lại Database</h6>
                                            <p>Đặt lại cấu trúc và dữ liệu cơ sở dữ liệu về trạng thái ban đầu</p>
                                        </div>
                                    </div>
                                    <div class="operation-actions">
                                        <button class="operation-btn btn-danger" disabled>
                                            <i class="fas fa-redo"></i> Đặt lại DB
                                        </button>
                                    </div>
                                </li>
                                
                                <li class="operation-item">
                                    <div class="operation-info">
                                        <div class="operation-icon settings">
                                            <i class="fas fa-cog"></i>
                                        </div>
                                        <div class="operation-details">
                                            <h6>Đặt lại Cài đặt</h6>
                                            <p>Khôi phục các cài đặt hệ thống về giá trị mặc định</p>
                                        </div>
                                    </div>
                                    <div class="operation-actions">
                                        <button class="operation-btn btn-warning" disabled>
                                            <i class="fas fa-sync"></i> Reset Settings
                                        </button>
                                    </div>
                                </li>
                                
                                <li class="operation-item">
                                    <div class="operation-info">
                                        <div class="operation-icon logs">
                                            <i class="fas fa-file-alt"></i>
                                        </div>
                                        <div class="operation-details">
                                            <h6>Xóa nhật ký</h6>
                                            <p>Xóa các tệp nhật ký cũ để giải phóng không gian đĩa</p>
                                        </div>
                                    </div>
                                    <div class="operation-actions">
                                        <button class="operation-btn btn-primary" data-toggle="modal" data-target="#clearLogsModal">
                                            <i class="fas fa-trash"></i> Xóa logs
                                        </button>
                                    </div>
                                </li>
                                
                                <li class="operation-item">
                                    <div class="operation-info">
                                        <div class="operation-icon restart">
                                            <i class="fas fa-redo"></i>
                                        </div>
                                        <div class="operation-details">
                                            <h6>Khởi động lại</h6>
                                            <p>Khởi động lại ứng dụng để áp dụng các thay đổi mới</p>
                                        </div>
                                    </div>
                                    <div class="operation-actions">
                                        <button type="button" class="operation-btn btn-secondary" disabled>
                                            <i class="fas fa-redo-alt"></i> Restart
                                        </button>
                                    </div>
                                </li>
                                
                                <li class="operation-item">
                                    <div class="operation-info">
                                        <div class="operation-icon reset">
                                            <i class="fas fa-exclamation-triangle"></i>
                                        </div>
                                        <div class="operation-details">
                                            <h6>Reset hệ thống</h6>
                                            <p>Đặt lại toàn bộ hệ thống về trạng thái ban đầu (Nguy hiểm!)</p>
                                        </div>
                                    </div>
                                    <div class="operation-actions">
                                        <button class="operation-btn btn-danger">
                                            <i class="fas fa-exclamation-triangle"></i> Reset
                                        </button>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Recent Activity Section -->
        <div class="row">
            <div class="col-md-6">
                <div class="card system-metrics">
                    <div class="card-header">
                        <h5>
                            <i class="fas fa-clock text-info"></i> 
                            Hoạt Động Gần Đây
                        </h5>
                        <small class="text-muted">
                            <i class="fas fa-sync-alt"></i> Cập nhật real-time
                        </small>
                    </div>
                    <div class="card-body">
                        <div class="activity-feed">
                            <div class="activity-item">
                                <div class="activity-icon bg-success">
                                    <i class="fas fa-user-plus text-white"></i>
                                </div>
                                <div class="activity-content">
                                    <h6 class="mb-1">Người dùng mới đăng ký</h6>
                                    <p class="mb-0 text-muted">
                                        <small>User ID: #12345</small>
                                    </p>
                                </div>
                                <div class="activity-time">
                                    <small class="text-muted">5 phút trước</small>
                                </div>
                            </div>
                            
                            <div class="activity-item">
                                <div class="activity-icon bg-primary">
                                    <i class="fas fa-calendar-check text-white"></i>
                                </div>
                                <div class="activity-content">
                                    <h6 class="mb-1">Ca thực hành mới được tạo</h6>
                                    <p class="mb-0 text-muted">
                                        <small>Lab Session: Python Basics</small>
                                    </p>
                                </div>
                                <div class="activity-time">
                                    <small class="text-muted">15 phút trước</small>
                                </div>
                            </div>
                            
                            <div class="activity-item">
                                <div class="activity-icon bg-warning">
                                    <i class="fas fa-sign-in-alt text-white"></i>
                                </div>
                                <div class="activity-content">
                                    <h6 class="mb-1">Admin đăng nhập</h6>
                                    <p class="mb-0 text-muted">
                                        <small>IP: {{ request.remote_addr or '192.168.1.100' }}</small>
                                    </p>
                                </div>
                                <div class="activity-time">
                                    <small class="text-muted">30 phút trước</small>
                                </div>
                            </div>
                            
                            <div class="activity-item">
                                <div class="activity-icon bg-info">
                                    <i class="fas fa-database text-white"></i>
                                </div>
                                <div class="activity-content">
                                    <h6 class="mb-1">Backup tự động</h6>
                                    <p class="mb-0 text-muted">
                                        <small>Size: 2.4 MB</small>
                                    </p>
                                </div>
                                <div class="activity-time">
                                    <small class="text-muted">1 giờ trước</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center mt-3">
                            <a href="{{ url_for('admin.activity_logs') }}" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-list"></i> Xem tất cả hoạt động
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card system-metrics mb-4">
                    <div class="card-header">
                        <h5>
                            <i class="fas fa-chart-pie text-success"></i> 
                            Thống Kê Hệ Thống
                        </h5>
                        <small class="text-muted">Tổng quan tình trạng</small>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="systemStatsChart" height="180"></canvas>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-6">
                                <div class="text-center">
                                    <h5 class="text-success mb-0">99.8%</h5>
                                    <small class="text-muted">Uptime</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="text-center">
                                    <h5 class="text-primary mb-0">45ms</h5>
                                    <small class="text-muted">Response Time</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats Card -->
                <div class="card system-metrics">
                    <div class="card-header">
                        <h5>
                            <i class="fas fa-tachometer-alt text-warning"></i> 
                            Thống Kê Nhanh
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="quick-stat-item">
                                    <i class="fas fa-users text-primary mb-2"></i>
                                    <h6 class="mb-0">{{ stats.user_count or 156 }}</h6>
                                    <small class="text-muted">Users</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="quick-stat-item">
                                    <i class="fas fa-calendar text-success mb-2"></i>
                                    <h6 class="mb-0">{{ stats.lab_session_count or 89 }}</h6>
                                    <small class="text-muted">Sessions</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="quick-stat-item">
                                    <i class="fas fa-chart-line text-info mb-2"></i>
                                    <h6 class="mb-0">{{ stats.activity_count or 1248 }}</h6>
                                    <small class="text-muted">Activities</small>
                                </div>
                            </div>
                        </div>
                        
                        <hr class="my-3">
                        
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="quick-stat-item">
                                    <i class="fas fa-exclamation-triangle text-warning mb-2"></i>
                                    <h6 class="mb-0">{{ stats.warning_alerts or 3 }}</h6>
                                    <small class="text-muted">Warnings</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="quick-stat-item">
                                    <i class="fas fa-check-circle text-success mb-2"></i>
                                    <h6 class="mb-0">98%</h6>
                                    <small class="text-muted">Success Rate</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Database Health Section -->
                <div class="card db-status-card">
                    <div class="card-header">
                        <h5>
                            <i class="fas fa-database text-info"></i> 
                            Tình Trạng Cơ Sở Dữ Liệu
                        </h5>
                        <small class="text-muted">Hiệu suất và sử dụng database</small>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <div class="db-stat-item">
                                    <div class="db-icon">
                                        <i class="fas fa-save text-primary"></i>
                                    </div>
                                    <div class="db-info">
                                        <h6 class="mb-1">Dung lượng</h6>
                                        <div class="progress mb-1" style="height: 8px;">
                                            <div class="progress-bar bg-primary" style="width: {{ stats.db_usage_percent or 65 }}%"></div>
                                        </div>
                                        <small class="text-muted">{{ stats.db_size or '5.2 MB' }} / 100 MB</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="db-stat-item">
                                    <div class="db-icon">
                                        <i class="fas fa-table text-success"></i>
                                    </div>
                                    <div class="db-info">
                                        <h6 class="mb-1">Bảng hoạt động</h6>
                                        <h5 class="text-success mb-0">{{ 
                                            (stats.user_count > 0) + 
                                            (stats.lab_session_count > 0) + 
                                            (stats.activity_count > 0) + 2 
                                        }}</h5>
                                        <small class="text-muted">/ 8 bảng chính</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <hr class="my-3">
                        
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="db-metric">
                                    <i class="fas fa-bolt text-warning mb-1"></i>
                                    <h6 class="mb-0">{{ 
                                        ((stats.user_count or 0) + (stats.lab_session_count or 0) + (stats.activity_count or 0)) / 1000 * 100 | round(1) if 
                                        ((stats.user_count or 0) + (stats.lab_session_count or 0) + (stats.activity_count or 0)) > 0 else 45.2 
                                    }}ms</h6>
                                    <small class="text-muted">Truy vấn TB</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="db-metric">
                                    <i class="fas fa-check-circle text-success mb-1"></i>
                                    <h6 class="mb-0">99.8%</h6>
                                    <small class="text-muted">Uptime DB</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="db-metric">
                                    <i class="fas fa-sync text-info mb-1"></i>
                                    <h6 class="mb-0">{{ 
                                        (stats.user_count or 0) + (stats.lab_session_count or 0) 
                                    }}</h6>
                                    <small class="text-muted">Kết nối</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Clear Logs Modal -->
<div class="modal fade" id="clearLogsModal" tabindex="-1" role="dialog" aria-labelledby="clearLogsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="clearLogsModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> Xác nhận xóa nhật ký
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-critical mb-3">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>CẢNH BÁO NGHIÊM TRỌNG:</strong> Hành động này sẽ xóa vĩnh viễn tất cả nhật ký hoạt động khỏi hệ thống.
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-12">
                        <h6><i class="fas fa-info-circle text-info"></i> Thông tin về thao tác:</h6>
                        <ul class="list-unstyled ml-3">
                            <li><i class="fas fa-check text-success"></i> Tất cả lịch sử hoạt động sẽ bị xóa</li>
                            <li><i class="fas fa-check text-success"></i> Không thể khôi phục sau khi xóa</li>
                            <li><i class="fas fa-check text-success"></i> Hành động sẽ được ghi nhận mới</li>
                        </ul>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="confirmText">
                        <strong>Để xác nhận, vui lòng nhập "XOA NHAT KY" vào ô bên dưới:</strong>
                    </label>
                    <input type="text" class="form-control" id="confirmText" placeholder="Nhập XOA NHAT KY để xác nhận">
                    <small class="form-text text-muted">Thao tác này yêu cầu xác nhận bằng văn bản</small>
                </div>
            </div>
                <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Hủy bỏ
                </button>
                <button type="button" class="btn btn-secondary" disabled>
                    <i class="fas fa-trash-alt"></i> Xóa nhật ký (Đang phát triển)
                </button>
            </div>
        </div>
    </div>
</div>

<!-- System Operations Confirmation Modal -->
<div class="modal fade" id="systemOperationModal" tabindex="-1" role="dialog" aria-labelledby="systemOperationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="systemOperationModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> Xác nhận thao tác hệ thống
                </h5>
                <button type="button" class="btn-close text-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-critical mb-4">
                    <i class="fas fa-radiation-alt"></i>
                    <strong>NGUY HIỂM:</strong> Bạn đang thực hiện thao tác có thể ảnh hưởng nghiêm trọng đến hệ thống!
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-shield-alt text-danger"></i> Biện pháp an toàn:</h6>
                        <ul class="list-unstyled ml-3">
                            <li><i class="fas fa-check text-success"></i> Đã sao lưu dữ liệu</li>
                            <li><i class="fas fa-check text-success"></i> Thông báo cho team</li>
                            <li><i class="fas fa-check text-success"></i> Kiểm tra maintenance window</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-clock text-warning"></i> Thời gian dự kiến:</h6>
                        <p class="ml-3">
                            <i class="fas fa-hourglass-half"></i> Downtime: <strong>5-15 phút</strong><br>
                            <i class="fas fa-sync"></i> Recovery: <strong>1-3 phút</strong>
                        </p>
                    </div>
                </div>
                
                <div class="form-group mt-3">
                    <label for="operationConfirmText">
                        <strong>Nhập "XAC NHAN THAO TAC" để tiếp tục:</strong>
                    </label>
                    <input type="text" class="form-control" id="operationConfirmText" placeholder="Nhập XAC NHAN THAO TAC">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Hủy bỏ
                </button>
                <button type="button" class="btn btn-danger" id="confirmOperationBtn" disabled>
                    <i class="fas fa-bolt"></i> Thực hiện thao tác
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Enhanced modal interactions
document.addEventListener('DOMContentLoaded', function() {
    // Clear logs modal validation
    const confirmText = document.getElementById('confirmText');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    
    if (confirmText && confirmDeleteBtn) {
        confirmText.addEventListener('input', function() {
            const isValid = this.value.trim().toUpperCase() === 'XOA NHAT KY';
            confirmDeleteBtn.disabled = !isValid;
            confirmDeleteBtn.classList.toggle('btn-danger', isValid);
            confirmDeleteBtn.classList.toggle('btn-secondary', !isValid);
        });
    }
    
    // System operation modal validation
    const operationConfirmText = document.getElementById('operationConfirmText');
    const confirmOperationBtn = document.getElementById('confirmOperationBtn');
    
    if (operationConfirmText && confirmOperationBtn) {
        operationConfirmText.addEventListener('input', function() {
            const isValid = this.value.trim().toUpperCase() === 'XAC NHAN THAO TAC';
            confirmOperationBtn.disabled = !isValid;
            confirmOperationBtn.classList.toggle('btn-danger', isValid);
            confirmOperationBtn.classList.toggle('btn-secondary', !isValid);
        });
    }
    
    // Enhanced button interactions for dangerous operations
    const dangerousButtons = document.querySelectorAll('a[href*="reset_"], a[href*="clear_"]');
    dangerousButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const operation = this.textContent.trim();
            const url = this.href;
            
            // Show system operation modal
            document.getElementById('systemOperationModalLabel').innerHTML = 
                `<i class="fas fa-exclamation-triangle"></i> Xác nhận: ${operation}`;
            
            document.getElementById('confirmOperationBtn').onclick = function() {
                window.location.href = url;
            };
            
            $('#systemOperationModal').modal('show');
        });
    });
    
    // Update time display - fix null element issue
    function updateTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('vi-VN', {
            hour12: false,
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        
        // Try both possible element IDs
        const currentTimeEl = document.getElementById('current-time');
        const lastUpdateEl = document.getElementById('last-update');
        
        if (currentTimeEl) {
            currentTimeEl.textContent = timeString;
        }
        if (lastUpdateEl) {
            lastUpdateEl.textContent = timeString;
        }
    }
    
    // Update time immediately and then every second
    updateTime();
    setInterval(updateTime, 1000);
    
    // Initialize real-time dashboard for admin manager - prevent multiple initialization
    if (typeof SystemDashboard !== 'undefined' && !window.systemDashboard) {
        console.log('✅ SystemDashboard class found, initializing...');
        try {
            window.systemDashboard = new SystemDashboard({
                type: 'system',
                realTime: true,
                updateInterval: 5000
            });
            console.log('✅ SystemDashboard instance created');
            
            systemDashboard.init();
            console.log('✅ SystemDashboard initialized successfully');
        } catch (error) {
            console.error('❌ Error initializing SystemDashboard:', error);
            alert('Lỗi khởi tạo dashboard: ' + error.message);
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (window.systemDashboard) {
                window.systemDashboard.cleanup();
            }
        });
    } else if (window.systemDashboard) {
        console.log('ℹ️ System Dashboard already initialized, skipping...');
    } else {
        console.error('❌ SystemDashboard class not found! Check if system_dashboard.js is loaded correctly.');
        
        // Fallback: Load simple dashboard script
        console.log('🔄 Loading simple dashboard fallback...');
        const script = document.createElement('script');
        script.src = '{{ url_for("static", filename="js/simple_dashboard.js") }}';
        script.onload = function() {
            console.log('✅ Simple dashboard script loaded');
        };
        script.onerror = function() {
            console.error('❌ Failed to load simple dashboard script');
            alert('Lỗi: Không thể tải dashboard script. Vui lòng kiểm tra kết nối mạng.');
        };
        document.head.appendChild(script);
    }
    
    // Test API directly to debug
    console.log('🧪 Testing API endpoint directly...');
    fetch('/api/v1/system/metrics-demo')
        .then(response => {
            console.log('📊 Direct API test:', response.status, response.statusText);
            return response.json();
        })
        .then(data => {
            console.log('✅ Direct API data:', data);
            
            // Test Chart.js availability
            console.log('📈 Chart.js available:', typeof Chart !== 'undefined');
            console.log('📈 Chart.js version:', typeof Chart !== 'undefined' ? Chart.version : 'N/A');
            
            // Test canvas elements
            const performanceCanvas = document.getElementById('performanceChart');
            const activityCanvas = document.getElementById('userActivityChart');
            console.log('🎨 Performance canvas found:', !!performanceCanvas);
            console.log('🎨 Activity canvas found:', !!activityCanvas);
            
            // Try to update one metric manually for testing
            const cpuElement = document.querySelector('#cpu-value, .metric-value:first-child, [data-metric="cpu"] .metric-value');
            if (cpuElement) {
                cpuElement.textContent = data.system.cpu_usage + '%';
                console.log('✅ Updated CPU value manually');
            } else {
                console.warn('⚠️ CPU element not found');
            }
        })
        .catch(error => {
            console.error('❌ Direct API test failed:', error);
            alert('API Test Error: ' + error.message);
        });
});
</script>
{% endblock %}