{% extends "index.html" %}

{% block title %}Quản lý người dùng{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin_tables.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .stats-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .stats-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    
    .stats-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
        margin-bottom: 15px;
    }
    
    .stats-number {
        font-size: 2.5rem;
        font-weight: 700;
        color: #2c3e50;
        line-height: 1;
    }
    
    .stats-label {
        color: #7f8c8d;
        font-size: 0.9rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .stats-change {
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    .advanced-filters {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .user-status-badge {
        display: inline-flex;
        align-items: center;
        padding: 4px 8px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .status-online {
        background-color: #d4edda;
        color: #155724;
    }
    
    .status-offline {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .status-idle {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .user-avatar-large {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1.2rem;
        color: white;
        margin-right: 12px;
    }
    
    .user-info-card {
        display: flex;
        align-items: center;
    }
    
    .user-details {
        flex: 1;
    }
    
    .user-name {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 2px;
    }
    
    .user-email {
        color: #7f8c8d;
        font-size: 0.9rem;
    }
    
    .action-btn {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: none;
        margin: 0 2px;
        transition: all 0.2s ease;
    }
    
    .action-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    
    .role-badge-modern {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .export-dropdown {
        border-radius: 8px;
    }
    
    .filter-chip {
        display: inline-flex;
        align-items: center;
        background-color: #e3f2fd;
        color: #1976d2;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        margin: 2px;
    }
    
    .filter-chip .remove-filter {
        margin-left: 8px;
        cursor: pointer;
        opacity: 0.7;
    }
    
    .filter-chip .remove-filter:hover {
        opacity: 1;
    }

    .notification-center {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 350px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            z-index: 1050;
        }
        
        .notification-header {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px 12px 0 0;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .notification-body {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .notification-item {
            display: flex;
            padding: 15px;
            border-bottom: 1px solid #f8f9fa;
        }
        
        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            color: white;
        }
        
        .notification-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .notification-text {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 4px;
        }
        
        .notification-time {
            font-size: 0.8rem;
            color: #adb5bd;
        }
        
        .upload-zone {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-zone:hover {
            border-color: #007bff;
            background-color: #f8f9ff;
        }
        
        .upload-zone.dragover {
            border-color: #007bff;
            background-color: #e3f2fd;
        }
        
        .security-score-card {
            text-align: center;
            padding: 20px;
        }
        
        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #28a745, #20c997);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
            color: white;
        }
        
        .score-number {
            font-size: 2.5rem;
            font-weight: 700;
        }
        
        .score-label {
            font-size: 0.9rem;
            margin-top: 5px;
        }
        
        .check-item {
            padding: 8px 0;
            font-size: 0.95rem;
        }
        
        .bg-gradient-primary {
            background: linear-gradient(135deg, #007bff, #0056b3);
        }
        
        .bg-gradient-success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        
        .bg-gradient-info {
            background: linear-gradient(135deg, #17a2b8, #138496);
        }
        
        .bg-gradient-warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
        }
        
        .import-steps .step {
            padding: 20px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .import-steps .step:last-child {
            border-bottom: none;
        }
        
        .import-steps .step.active {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
        }
    </style>
{% endblock %}

{% block content %}
{% if current_user.is_authenticated and current_user.is_admin() %}
<div class="container-fluid">
    <!-- Enhanced Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-2 text-gray-800">
                        <i class="fas fa-users text-primary mr-2"></i>Quản lý người dùng
                    </h1>
                    <p class="text-muted">Quản lý tất cả người dùng, vai trò và quyền hạn trong hệ thống</p>
                </div>
                <div class="d-flex gap-2">
                    <div class="dropdown">
                        <button class="btn btn-outline-primary dropdown-toggle" type="button" id="exportDropdown" data-toggle="dropdown">
                            <i class="fas fa-download mr-1"></i>Xuất dữ liệu
                        </button>
                        <div class="dropdown-menu export-dropdown">
                            <a class="dropdown-item" href="#" id="exportExcel">
                                <i class="fas fa-file-excel text-success mr-2"></i>Xuất Excel
                            </a>
                            <a class="dropdown-item" href="#" id="exportCSV">
                                <i class="fas fa-file-csv text-info mr-2"></i>Xuất CSV
                            </a>
                            <a class="dropdown-item" href="#" id="exportPDF">
                                <i class="fas fa-file-pdf text-danger mr-2"></i>Xuất PDF
                            </a>
                        </div>
                    </div>
                    <a href="{{ url_for('admin.create_user') }}" class="btn btn-primary">
                        <i class="fas fa-user-plus mr-1"></i>Tạo người dùng mới
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card stats-card h-100">
                <div class="card-body">
                    <div class="stats-icon bg-primary">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stats-number" id="totalUsers">{{ users|length }}</div>
                    <div class="stats-label">Tổng người dùng</div>
                    <div class="stats-change text-success">
                        <i class="fas fa-arrow-up mr-1"></i>+5% tuần này
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card stats-card h-100">
                <div class="card-body">
                    <div class="stats-icon bg-success">
                        <i class="fas fa-user-check"></i>
                    </div>
                    <div class="stats-number" id="activeUsers">
                        {{ users|selectattr('last_login')|list|length }}
                    </div>
                    <div class="stats-label">Người dùng hoạt động</div>
                    <div class="stats-change text-success">
                        <i class="fas fa-arrow-up mr-1"></i>+12% tuần này
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card stats-card h-100">
                <div class="card-body">
                    <div class="stats-icon bg-warning">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div class="stats-number" id="adminUsers">
                        {{ users|selectattr('vai_tro', 'in', ['quan_tri_vien', 'quan_tri_he_thong'])|list|length }}
                    </div>
                    <div class="stats-label">Quản trị viên</div>
                    <div class="stats-change text-info">
                        <i class="fas fa-minus mr-1"></i>Không đổi
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card stats-card h-100">
                <div class="card-body">
                    <div class="stats-icon bg-info">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stats-number" id="onlineUsers">0</div>
                    <div class="stats-label">Đang trực tuyến</div>
                    <div class="stats-change text-muted">
                        <i class="fas fa-sync-alt mr-1"></i>Thời gian thực
                    </div>
                </div>
            </div>
        </div>
    </div>    <!-- Advanced Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">
                            <i class="fas fa-filter mr-2"></i>Bộ lọc và tìm kiếm
                        </h5>
                        <button class="btn btn-sm btn-outline-secondary" id="toggleAdvancedFilters">
                            <i class="fas fa-cog mr-1"></i>Bộ lọc nâng cao
                        </button>
                    </div>
                    
                    <!-- Basic Search -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text">
                                        <i class="fas fa-search"></i>
                                    </span>
                                </div>
                                <input type="text" class="form-control" id="searchInput" placeholder="Tìm kiếm theo tên, email..." value="{{ request.args.get('search', '') }}">
                                <div class="input-group-append">
                                    <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-control" id="roleFilter" name="role">
                                <option value="">Tất cả vai trò</option>
                                <option value="nguoi_dung" {% if request.args.get('role') == 'nguoi_dung' %}selected{% endif %}>Người dùng</option>
                                <option value="quan_tri_vien" {% if request.args.get('role') == 'quan_tri_vien' %}selected{% endif %}>Quản trị viên</option>
                                <option value="quan_tri_he_thong" {% if request.args.get('role') == 'quan_tri_he_thong' %}selected{% endif %}>Quản trị hệ thống</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-control" id="statusFilter">
                                <option value="">Tất cả trạng thái</option>
                                <option value="active">Hoạt động</option>
                                <option value="inactive">Không hoạt động</option>
                                <option value="online">Đang trực tuyến</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Advanced Filters (Hidden by default) -->
                    <div id="advancedFilters" class="advanced-filters mt-3" style="display: none;">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">Ngày tạo từ:</label>
                                <input type="date" class="form-control" id="dateFromFilter">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Ngày tạo đến:</label>
                                <input type="date" class="form-control" id="dateToFilter">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Sắp xếp theo:</label>
                                <select class="form-control" id="sortByFilter">
                                    <option value="created_desc">Mới nhất</option>
                                    <option value="created_asc">Cũ nhất</option>
                                    <option value="name_asc">Tên A-Z</option>
                                    <option value="name_desc">Tên Z-A</option>
                                    <option value="login_desc">Đăng nhập gần nhất</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Hiển thị:</label>
                                <select class="form-control" id="itemsPerPage">
                                    <option value="10">10 mục/trang</option>
                                    <option value="25" selected>25 mục/trang</option>
                                    <option value="50">50 mục/trang</option>
                                    <option value="100">100 mục/trang</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <button class="btn btn-primary mr-2" id="applyFilters">
                                    <i class="fas fa-check mr-1"></i>Áp dụng bộ lọc
                                </button>
                                <button class="btn btn-secondary" id="resetFilters">
                                    <i class="fas fa-undo mr-1"></i>Đặt lại
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Active Filters Display -->
                    <div id="activeFilters" class="mt-3" style="display: none;">
                        <small class="text-muted">Bộ lọc đang áp dụng:</small>
                        <div id="filterChips" class="mt-1"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>    <!-- Enhanced Users Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-1">
                                <i class="fas fa-table mr-2 text-primary"></i>Danh sách người dùng
                            </h4>
                            <p class="text-muted mb-0">
                                Hiển thị <span id="displayedCount">{{ users|length }}</span> trong tổng số <span id="totalCount">{{ users|length }}</span> người dùng
                            </p>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="btn-group mr-2" role="group">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="refreshTable" data-toggle="tooltip" title="Làm mới">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="tableSettings" data-toggle="tooltip" title="Cài đặt bảng">
                                    <i class="fas fa-cog"></i>
                                </button>
                            </div>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="gridView" data-toggle="tooltip" title="Dạng lưới">
                                    <i class="fas fa-th"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-primary" id="listView" data-toggle="tooltip" title="Dạng danh sách">
                                    <i class="fas fa-list"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table admin-table mb-0">                            <thead>
                                <tr>
                                    <th class="sortable" data-sort="name">
                                        <i class="fas fa-user mr-1"></i>Người dùng
                                    </th>
                                    <th class="sortable" data-sort="role">
                                        <i class="fas fa-shield-alt mr-1"></i>Vai trò
                                    </th>
                                    <th class="sortable" data-sort="status">
                                        <i class="fas fa-circle mr-1"></i>Trạng thái
                                    </th>
                                    <th class="sortable" data-sort="last_login">
                                        <i class="fas fa-clock mr-1"></i>Hoạt động cuối
                                    </th>
                                    <th class="sortable" data-sort="created">
                                        <i class="fas fa-calendar mr-1"></i>Ngày tạo
                                    </th>
                                    <th width="150px">
                                        <i class="fas fa-cogs mr-1"></i>Thao tác
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                {% for user in users %}                                <tr data-user-id="{{ user.id }}" class="user-row">
                                    <td>
                                        <div class="user-info-card">
                                            <div class="user-avatar-large" style="background: linear-gradient(135deg, {{ user.avatar_color or '#007bff' }}, {{ user.avatar_color or '#0056b3' }});">
                                                {{ user.ten_nguoi_dung[0] }}
                                            </div>
                                            <div class="user-details">
                                                <div class="user-name">{{ user.ten_nguoi_dung }}</div>
                                                <div class="user-email">{{ user.email }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="role-badge-modern 
                                            {% if user.vai_tro == 'quan_tri_he_thong' %}bg-danger text-white
                                            {% elif user.vai_tro == 'quan_tri_vien' %}bg-warning text-dark
                                            {% else %}bg-primary text-white{% endif %}">
                                            {% if user.vai_tro == 'quan_tri_he_thong' %}
                                                <i class="fas fa-crown mr-1"></i>Quản trị hệ thống
                                            {% elif user.vai_tro == 'quan_tri_vien' %}
                                                <i class="fas fa-shield-alt mr-1"></i>Quản trị viên
                                            {% else %}
                                                <i class="fas fa-user mr-1"></i>Người dùng
                                            {% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="user-status-badge status-{% if user.last_login and (now() - user.last_login).days < 1 %}online{% elif user.last_login %}offline{% else %}idle{% endif %}">
                                            <i class="fas fa-circle mr-1" style="font-size: 8px;"></i>
                                            {% if user.last_login and (now() - user.last_login).days < 1 %}
                                                Trực tuyến
                                            {% elif user.last_login %}
                                                Ngoại tuyến
                                            {% else %}
                                                Chưa đăng nhập
                                            {% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        {% if user.last_login %}
                                            <span data-toggle="tooltip" title="{{ user.last_login.strftime('%d/%m/%Y %H:%M:%S') }}">
                                                {{ moment(user.last_login).fromNow() if moment else user.last_login.strftime('%d/%m/%Y') }}
                                            </span>
                                        {% else %}
                                            <span class="text-muted">Chưa bao giờ</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span data-toggle="tooltip" title="{{ user.ngay_tao.strftime('%d/%m/%Y %H:%M:%S') }}">
                                            {{ user.ngay_tao.strftime('%d/%m/%Y') }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="d-flex">
                                            <button type="button" class="action-btn btn-outline-info" data-toggle="modal" data-target="#userDetailsModal{{ user.id }}" data-toggle="tooltip" title="Xem chi tiết">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <a href="{{ url_for('admin.edit_user', user_id=user.id) }}" class="action-btn btn-outline-warning" data-toggle="tooltip" title="Chỉnh sửa">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            {% if user.vai_tro != 'quan_tri_he_thong' or current_user.is_admin_manager() %}
                                            <button type="button" class="action-btn btn-outline-success" onclick="sendMessage({{ user.id }})" data-toggle="tooltip" title="Gửi tin nhắn">
                                                <i class="fas fa-envelope"></i>
                                            </button>
                                            <button type="button" class="action-btn btn-outline-danger" data-toggle="modal" data-target="#deleteModal{{ user.id }}" data-toggle="tooltip" title="Xóa người dùng">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="7" class="text-center py-5">
                                        <div class="text-muted">
                                            <i class="fas fa-users fa-3x mb-3"></i>
                                            <h5>Không có người dùng nào</h5>
                                            <p>Không tìm thấy người dùng phù hợp với bộ lọc hiện tại.</p>
                                            <a href="{{ url_for('admin.create_user') }}" class="btn btn-primary">
                                                <i class="fas fa-user-plus mr-1"></i>Tạo người dùng đầu tiên
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Enhanced Pagination -->
                    <div class="card-footer bg-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="text-muted">
                                Hiển thị <strong>1-{{ users|length }}</strong> trong tổng số <strong>{{ users|length }}</strong> kết quả
                            </div>
                            <nav aria-label="User pagination">
                                <ul class="pagination pagination-sm mb-0">
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" tabindex="-1">
                                            <i class="fas fa-chevron-left"></i>
                                        </a>
                                    </li>
                                    <li class="page-item active">
                                        <a class="page-link" href="#">1</a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="#">2</a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="#">3</a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="#">
                                            <i class="fas fa-chevron-right"></i>
                                        </a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced User Activity Tracking -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line mr-2 text-success"></i>Hoạt động người dùng gần đây
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <canvas id="userActivityChart" width="400" height="100"></canvas>
                        </div>
                        <div class="col-md-4">
                            <div class="activity-summary">
                                <h6>Tóm tắt 24h qua:</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-user-plus text-success mr-2"></i>{{ new_users_today|default(3) }} người dùng mới</li>
                                    <li><i class="fas fa-sign-in-alt text-info mr-2"></i>{{ active_sessions|default(12) }} phiên đăng nhập</li>
                                    <li><i class="fas fa-exclamation-triangle text-warning mr-2"></i>{{ failed_logins|default(2) }} lần đăng nhập thất bại</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Performance Metrics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-gradient-primary text-white">
                <div class="card-body">
                    <div class="d-flex">
                        <div class="mr-3">
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                        <div>
                            <div class="h4 mb-0">{{ avg_session_time|default("45m") }}</div>
                            <div class="small">Thời gian phiên TB</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-gradient-success text-white">
                <div class="card-body">
                    <div class="d-flex">
                        <div class="mr-3">
                            <i class="fas fa-percentage fa-2x"></i>
                        </div>
                        <div>
                            <div class="h4 mb-0">{{ user_retention|default("87%") }}</div>
                            <div class="small">Tỷ lệ người dùng quay lại</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-gradient-info text-white">
                <div class="card-body">
                    <div class="d-flex">
                        <div class="mr-3">
                            <i class="fas fa-chart-pie fa-2x"></i>
                        </div>
                        <div>
                            <div class="h4 mb-0">{{ peak_hours|default("2-4PM") }}</div>
                            <div class="small">Giờ cao điểm</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-gradient-warning text-white">
                <div class="card-body">
                    <div class="d-flex">
                        <div class="mr-3">
                            <i class="fas fa-shield-alt fa-2x"></i>
                        </div>
                        <div>
                            <div class="h4 mb-0">{{ security_score|default("98%") }}</div>
                            <div class="small">Điểm bảo mật</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions Panel -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-bolt mr-2 text-warning"></i>Thao tác nhanh
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2">
                            <button class="btn btn-outline-success btn-block" id="quickCreateUser">
                                <i class="fas fa-user-plus mb-1"></i><br>
                                <small>Tạo nhanh</small>
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-info btn-block" id="importUsers">
                                <i class="fas fa-file-import mb-1"></i><br>                                <small>Import CSV</small>
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-danger btn-block" id="securityAudit">
                                <i class="fas fa-shield-alt mb-1"></i><br>
                                <small>Kiểm tra BM</small>
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-primary btn-block" id="generateReport">
                                <i class="fas fa-chart-bar mb-1"></i><br>
                                <small>Báo cáo</small>
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-secondary btn-block" id="systemCleanup">
                                <i class="fas fa-broom mb-1"></i><br>
                                <small>Dọn dẹp</small>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Notification System -->
    <div id="notificationCenter" class="notification-center" style="display: none;">
        <div class="notification-header">
            <h6><i class="fas fa-bell mr-2"></i>Thông báo hệ thống</h6>
            <button class="btn btn-sm btn-light" id="closeNotifications">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="notification-body">
            <div class="notification-item">
                <div class="notification-icon bg-success">
                    <i class="fas fa-user-check"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">Người dùng mới đăng ký</div>
                    <div class="notification-text">3 người dùng mới đã đăng ký trong 1 giờ qua</div>
                    <div class="notification-time">2 phút trước</div>
                </div>
            </div>
            <div class="notification-item">
                <div class="notification-icon bg-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">Cảnh báo bảo mật</div>
                    <div class="notification-text">Phát hiện 5 lần đăng nhập thất bại từ IP lạ</div>
                    <div class="notification-time">15 phút trước</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Users Modal -->
    <div class="modal fade" id="importUsersModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-file-import mr-2"></i>Import người dùng từ CSV
                    </h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="import-steps">
                        <div class="step active" data-step="1">
                            <h6><i class="fas fa-upload mr-2"></i>Bước 1: Chọn file CSV</h6>
                            <div class="upload-zone" id="csvUploadZone">
                                <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                <p>Kéo thả file CSV vào đây hoặc click để chọn</p>
                                <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
                                <button type="button" class="btn btn-primary" id="selectCsvFile">
                                    Chọn file CSV
                                </button>
                            </div>
                        </div>
                        <div class="step" data-step="2" style="display: none;">
                            <h6><i class="fas fa-cogs mr-2"></i>Bước 2: Cấu hình import</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <label>Mapping cột:</label>
                                    <div id="columnMapping"></div>
                                </div>
                                <div class="col-md-6">
                                    <label>Tùy chọn:</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="skipDuplicates" checked>
                                        <label class="form-check-label" for="skipDuplicates">
                                            Bỏ qua email trùng lặp
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="sendWelcomeEmail">
                                        <label class="form-check-label" for="sendWelcomeEmail">
                                            Gửi email chào mừng
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="step" data-step="3" style="display: none;">
                            <h6><i class="fas fa-check mr-2"></i>Bước 3: Xác nhận và import</h6>
                            <div class="import-preview" id="importPreview"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="prevStep" style="display: none;">
                        <i class="fas fa-arrow-left mr-1"></i>Quay lại
                    </button>
                    <button type="button" class="btn btn-primary" id="nextStep">
                        Tiếp theo <i class="fas fa-arrow-right ml-1"></i>
                    </button>
                    <button type="button" class="btn btn-success" id="startImport" style="display: none;">
                        <i class="fas fa-play mr-1"></i>Bắt đầu import
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Security Audit Modal -->
    <div class="modal fade" id="securityAuditModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-shield-alt mr-2"></i>Kiểm tra bảo mật hệ thống
                    </h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="security-scan-results">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="security-score-card">
                                    <div class="score-circle">
                                        <span class="score-number">98</span>
                                        <span class="score-label">Điểm BM</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="security-checklist">
                                    <div class="check-item passed">
                                        <i class="fas fa-check-circle text-success mr-2"></i>
                                        Mật khẩu mạnh được áp dụng
                                    </div>
                                    <div class="check-item passed">
                                        <i class="fas fa-check-circle text-success mr-2"></i>
                                        Không có tài khoản không hoạt động quá 90 ngày
                                    </div>
                                    <div class="check-item warning">
                                        <i class="fas fa-exclamation-triangle text-warning mr-2"></i>
                                        2 tài khoản chưa đổi mật khẩu mặc định
                                    </div>
                                    <div class="check-item passed">
                                        <i class="fas fa-check-circle text-success mr-2"></i>
                                        Phiên đăng nhập được bảo mật
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="downloadSecurityReport">
                        <i class="fas fa-download mr-1"></i>Tải báo cáo
                    </button>
                    <button type="button" class="btn btn-success" id="fixSecurityIssues">
                        <i class="fas fa-wrench mr-1"></i>Sửa tự động
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete User Modals -->
    {% for user in users %}
    <div class="modal fade" id="deleteModal{{ user.id }}" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel{{ user.id }}">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteModalLabel{{ user.id }}">
                        <i class="fas fa-trash mr-2"></i>Xác nhận xóa người dùng
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <i class="fas fa-exclamation-triangle text-danger fa-3x mb-3"></i>
                        <h4>Cảnh báo!</h4>
                    </div>
                    <p class="lead text-center">
                        Bạn có chắc chắn muốn xóa người dùng <strong>{{ user.ten_nguoi_dung }}</strong>?
                    </p>
                    <div class="alert alert-warning">
                        <i class="fas fa-info-circle mr-2"></i>
                        <strong>Lưu ý:</strong> Hành động này không thể hoàn tác. Tất cả dữ liệu liên quan đến người dùng này sẽ bị xóa vĩnh viễn.
                    </div>
                    <div class="user-info-summary">
                        <div class="row">
                            <div class="col-sm-6">
                                <strong>Email:</strong><br>
                                <span class="text-muted">{{ user.email }}</span>
                            </div>
                            <div class="col-sm-6">
                                <strong>Vai trò:</strong><br>
                                <span class="badge 
                                    {% if user.vai_tro == 'quan_tri_he_thong' %}badge-danger
                                    {% elif user.vai_tro == 'quan_tri_vien' %}badge-warning
                                    {% else %}badge-info{% endif %}">
                                    {{ user.vai_tro }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times mr-1"></i>Hủy
                    </button>
                    <button type="button" class="btn btn-danger" onclick="deleteUser({{ user.id }})">
                        <i class="fas fa-trash mr-1"></i>Xóa người dùng
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

    <!-- User Details Modals -->
    {% for user in users %}
    <div class="modal fade" id="userDetailsModal{{ user.id }}" tabindex="-1" role="dialog" aria-labelledby="userDetailsModalLabel{{ user.id }}">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="userDetailsModalLabel{{ user.id }}">
                        <i class="fas fa-user mr-2"></i>Chi tiết người dùng
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4 text-center">
                            <div class="user-avatar-large mb-3" style="background: linear-gradient(135deg, {{ user.avatar_color or '#007bff' }}, {{ user.avatar_color or '#0056b3' }}); width: 120px; height: 120px; font-size: 48px; line-height: 120px; margin: 0 auto;">
                                {{ user.ten_nguoi_dung[0] }}
                            </div>
                            <h4>{{ user.ten_nguoi_dung }}</h4>
                            <p class="text-muted">{{ user.email }}</p>
                        </div>
                        <div class="col-md-8">
                            <table class="table table-borderless">
                                <tr>
                                    <th width="30%">Vai trò:</th>
                                    <td>
                                        <span class="badge 
                                            {% if user.vai_tro == 'quan_tri_he_thong' %}badge-danger
                                            {% elif user.vai_tro == 'quan_tri_vien' %}badge-warning
                                            {% else %}badge-info{% endif %}">
                                            {{ user.vai_tro }}
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Ngày tạo:</th>
                                    <td>{{ user.ngay_tao.strftime('%d/%m/%Y %H:%M:%S') if user.ngay_tao else 'N/A' }}</td>
                                </tr>
                                <tr>
                                    <th>Lần đăng nhập cuối:</th>
                                    <td>
                                        {% if user.last_login %}
                                            {{ user.last_login.strftime('%d/%m/%Y %H:%M:%S') }}
                                        {% else %}
                                            <span class="text-muted">Chưa đăng nhập</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Trạng thái:</th>
                                    <td>
                                        <span class="user-status-badge status-{% if user.last_login and (now() - user.last_login).days < 1 %}online{% elif user.last_login %}offline{% else %}idle{% endif %}">
                                            <i class="fas fa-circle mr-1" style="font-size: 8px;"></i>
                                            {% if user.last_login and (now() - user.last_login).days < 1 %}
                                                Trực tuyến
                                            {% elif user.last_login %}
                                                Ngoại tuyến
                                            {% else %}
                                                Chưa đăng nhập
                                            {% endif %}
                                        </span>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                    <a href="{{ url_for('admin.edit_user', user_id=user.id) }}" class="btn btn-warning">
                        <i class="fas fa-edit mr-1"></i>Chỉnh sửa
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="alert alert-danger mt-5">Bạn không có quyền truy cập trang này.</div>
{% endif %}
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/admin_tables.js') }}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

<script>
class UserManagement {
    constructor() {
        this.currentFilters = {};
        this.sortOrder = { column: 'created', direction: 'desc' };
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.initializeTooltips();
        this.loadUserStats();
        this.setupRealTimeUpdates();
        this.setupAdvancedFeatures();
    }

    setupEventListeners() {
        // Search functionality
        const searchInput = document.getElementById('searchInput');
        let searchTimeout;
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                this.applyFilters();
            }, 300);
        });

        // Clear search
        document.getElementById('clearSearch').addEventListener('click', () => {
            searchInput.value = '';
            this.applyFilters();
        });

        // Filter controls
        document.getElementById('roleFilter').addEventListener('change', () => this.applyFilters());
        document.getElementById('statusFilter').addEventListener('change', () => this.applyFilters());

        // Advanced filters toggle
        document.getElementById('toggleAdvancedFilters').addEventListener('click', () => {
            this.toggleAdvancedFilters();
        });

        // Apply and reset filters
        document.getElementById('applyFilters').addEventListener('click', () => this.applyFilters());
        document.getElementById('resetFilters').addEventListener('click', () => this.resetFilters());        // Export functionality
        document.getElementById('exportExcel').addEventListener('click', () => this.exportData('excel'));
        document.getElementById('exportCSV').addEventListener('click', () => this.exportData('csv'));
        document.getElementById('exportPDF').addEventListener('click', () => this.exportData('pdf'));

        // Table view toggle
        document.getElementById('gridView').addEventListener('click', () => this.switchToGridView());
        document.getElementById('listView').addEventListener('click', () => this.switchToListView());

        // Refresh table
        document.getElementById('refreshTable').addEventListener('click', () => this.refreshTable());

        // Sort functionality
        document.querySelectorAll('.sortable').forEach(header => {
            header.addEventListener('click', () => {
                const column = header.getAttribute('data-sort');
                this.sortTable(column);
            });
        });
    }

    initializeTooltips() {
        $('[data-toggle="tooltip"]').tooltip();
    }

    loadUserStats() {
        // Simulate loading real-time stats
        this.updateOnlineUsers();
        setInterval(() => {
            this.updateOnlineUsers();
        }, 30000); // Update every 30 seconds
    }

    updateOnlineUsers() {
        // Simulate online user count
        const onlineCount = Math.floor(Math.random() * 10) + 1;
        document.getElementById('onlineUsers').textContent = onlineCount;
    }

    setupRealTimeUpdates() {
        // Setup WebSocket or periodic updates for real-time status
        setInterval(() => {
            this.updateUserStatuses();
        }, 60000); // Update every minute
    }

    updateUserStatuses() {
        // Update user status indicators in real-time
        document.querySelectorAll('.user-status-badge').forEach(badge => {
            // Simulate status changes
            const statuses = ['online', 'offline', 'idle'];
            const randomStatus = statuses[Math.floor(Math.random() * statuses.length)];
            badge.className = `user-status-badge status-${randomStatus}`;
        });
    }

    toggleAdvancedFilters() {
        const advancedFilters = document.getElementById('advancedFilters');
        const isVisible = advancedFilters.style.display !== 'none';
        advancedFilters.style.display = isVisible ? 'none' : 'block';
        
        const toggleBtn = document.getElementById('toggleAdvancedFilters');
        const icon = toggleBtn.querySelector('i');
        icon.className = isVisible ? 'fas fa-cog mr-1' : 'fas fa-times mr-1';
    }

    applyFilters() {
        const filters = {
            search: document.getElementById('searchInput').value,
            role: document.getElementById('roleFilter').value,
            status: document.getElementById('statusFilter').value,
            dateFrom: document.getElementById('dateFromFilter')?.value,
            dateTo: document.getElementById('dateToFilter')?.value,
            sortBy: document.getElementById('sortByFilter')?.value
        };

        this.currentFilters = filters;
        this.filterUsers(filters);
        this.updateActiveFilters(filters);
    }

    filterUsers(filters) {
        const rows = document.querySelectorAll('#usersTableBody .user-row');
        let visibleCount = 0;

        rows.forEach(row => {
            let shouldShow = true;

            // Apply search filter
            if (filters.search) {
                const userInfo = row.querySelector('.user-details').textContent.toLowerCase();
                shouldShow = shouldShow && userInfo.includes(filters.search.toLowerCase());
            }

            // Apply role filter
            if (filters.role) {
                const roleBadge = row.querySelector('.role-badge-modern');
                shouldShow = shouldShow && roleBadge.textContent.toLowerCase().includes(filters.role);
            }

            // Apply status filter
            if (filters.status) {
                const statusBadge = row.querySelector('.user-status-badge');
                shouldShow = shouldShow && statusBadge.classList.contains(`status-${filters.status}`);
            }

            row.style.display = shouldShow ? '' : 'none';
            if (shouldShow) visibleCount++;
        });

        document.getElementById('displayedCount').textContent = visibleCount;
    }

    updateActiveFilters(filters) {
        const activeFilters = document.getElementById('activeFilters');
        const filterChips = document.getElementById('filterChips');
        
        filterChips.innerHTML = '';
        let hasActiveFilters = false;

        Object.entries(filters).forEach(([key, value]) => {
            if (value && value !== '') {
                hasActiveFilters = true;
                const chip = document.createElement('span');
                chip.className = 'filter-chip';
                chip.innerHTML = `
                    ${this.getFilterLabel(key)}: ${value}
                    <span class="remove-filter" onclick="userMgmt.removeFilter('${key}')">×</span>
                `;
                filterChips.appendChild(chip);
            }
        });

        activeFilters.style.display = hasActiveFilters ? 'block' : 'none';
    }

    getFilterLabel(key) {
        const labels = {
            search: 'Tìm kiếm',
            role: 'Vai trò',
            status: 'Trạng thái',
            dateFrom: 'Từ ngày',
            dateTo: 'Đến ngày',
            sortBy: 'Sắp xếp'
        };
        return labels[key] || key;
    }

    removeFilter(key) {
        const element = document.getElementById(key === 'search' ? 'searchInput' : `${key}Filter`);
        if (element) {
            element.value = '';
            this.applyFilters();
        }
    }

    resetFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('roleFilter').value = '';
        document.getElementById('statusFilter').value = '';
        if (document.getElementById('dateFromFilter')) document.getElementById('dateFromFilter').value = '';
        if (document.getElementById('dateToFilter')) document.getElementById('dateToFilter').value = '';        this.applyFilters();
    }

    sortTable(column) {
        if (this.sortOrder.column === column) {
            this.sortOrder.direction = this.sortOrder.direction === 'asc' ? 'desc' : 'asc';
        } else {
            this.sortOrder.column = column;
            this.sortOrder.direction = 'asc';
        }

        // Update sort indicators
        document.querySelectorAll('.sortable').forEach(header => {
            header.classList.remove('asc', 'desc');
        });
        
        const currentHeader = document.querySelector(`[data-sort="${column}"]`);
        currentHeader.classList.add(this.sortOrder.direction);

        // Perform sort (this would typically be done server-side)
        this.performTableSort();
    }

    performTableSort() {
        // Client-side sorting implementation
        const tbody = document.getElementById('usersTableBody');
        const rows = Array.from(tbody.querySelectorAll('.user-row'));
        
        rows.sort((a, b) => {
            let aVal, bVal;
            
            switch (this.sortOrder.column) {
                case 'name':
                    aVal = a.querySelector('.user-name').textContent;
                    bVal = b.querySelector('.user-name').textContent;
                    break;
                case 'role':
                    aVal = a.querySelector('.role-badge-modern').textContent;
                    bVal = b.querySelector('.role-badge-modern').textContent;
                    break;
                case 'status':
                    aVal = a.querySelector('.user-status-badge').textContent;
                    bVal = b.querySelector('.user-status-badge').textContent;
                    break;
                default:
                    return 0;
            }
            
            const compare = aVal.localeCompare(bVal);
            return this.sortOrder.direction === 'asc' ? compare : -compare;
        });
        
        rows.forEach(row => tbody.appendChild(row));
    }

    exportData(format) {
        const data = this.getTableData();
        
        switch (format) {
            case 'excel':
                this.exportToExcel(data);
                break;
            case 'csv':
                this.exportToCSV(data);
                break;
            case 'pdf':
                this.exportToPDF(data);                break;
        }
    }

    getTableData() {
        const rows = document.querySelectorAll('#usersTableBody .user-row');
        const data = [];
        
        rows.forEach(row => {
            if (row.style.display === 'none') return;
            
            const cells = row.querySelectorAll('td');
            data.push({
                name: cells[0].querySelector('.user-name').textContent,
                email: cells[0].querySelector('.user-email').textContent,
                role: cells[1].textContent.trim(),
                status: cells[2].textContent.trim(),
                lastActivity: cells[3].textContent.trim(),
                created: cells[4].textContent.trim()
            });
        });
        
        return data;
    }

    exportToCSV(data, filename = 'users') {
        const csv = this.convertToCSV(data);
        this.downloadFile(csv, `${filename}.csv`, 'text/csv');
    }

    exportToExcel(data) {
        // Implementation for Excel export
        console.log('Excel export functionality would be implemented here');
    }

    exportToPDF(data) {
        // Implementation for PDF export
        console.log('PDF export functionality would be implemented here');
    }

    convertToCSV(data) {
        if (data.length === 0) return '';
        
        const headers = Object.keys(data[0]);
        const csvContent = [
            headers.join(','),
            ...data.map(row => headers.map(header => `"${row[header]}"`).join(','))
        ].join('\n');
        
        return csvContent;
    }

    downloadFile(content, filename, contentType) {
        const blob = new Blob([content], { type: contentType });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }

    switchToGridView() {
        // Implementation for grid view
        document.getElementById('gridView').classList.add('btn-primary');
        document.getElementById('gridView').classList.remove('btn-outline-secondary');
        document.getElementById('listView').classList.add('btn-outline-secondary');
        document.getElementById('listView').classList.remove('btn-primary');
        
        console.log('Grid view would be implemented here');
    }

    switchToListView() {
        // Current view is already list view
        document.getElementById('listView').classList.add('btn-primary');
        document.getElementById('listView').classList.remove('btn-outline-secondary');
        document.getElementById('gridView').classList.add('btn-outline-secondary');
        document.getElementById('gridView').classList.remove('btn-primary');
    }    refreshTable() {
        window.location.reload();
    }

    setupAdvancedFeatures() {
        // Activity Chart
        this.initActivityChart();
        
        // Quick Actions
        this.setupQuickActions();
        
        // Notification System
        this.setupNotificationSystem();
        
        // Import System
        this.setupImportSystem();
        
        // Security Audit
        this.setupSecurityAudit();
    }

    initActivityChart() {
        const ctx = document.getElementById('userActivityChart');
        if (ctx) {
            new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00', '24:00'],
                    datasets: [{
                        label: 'Người dùng hoạt động',
                        data: [5, 2, 8, 15, 25, 18, 12],
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    }

    setupQuickActions() {
        // Quick Create User
        document.getElementById('quickCreateUser')?.addEventListener('click', () => {
            window.location.href = '/admin/create-user';
        });

        // Import Users
        document.getElementById('importUsers')?.addEventListener('click', () => {
            $('#importUsersModal').modal('show');        });

        // Security Audit
        document.getElementById('securityAudit')?.addEventListener('click', () => {
            $('#securityAuditModal').modal('show');
            this.runSecurityAudit();
        });

        // Generate Report
        document.getElementById('generateReport')?.addEventListener('click', () => {
            this.generateAdvancedReport();
        });

        // System Cleanup
        document.getElementById('systemCleanup')?.addEventListener('click', () => {
            this.showSystemCleanupDialog();
        });
    }

    setupNotificationSystem() {
        // Show notifications periodically
        setInterval(() => {
            this.checkForNotifications();
        }, 30000); // Check every 30 seconds

        // Close notifications
        document.getElementById('closeNotifications')?.addEventListener('click', () => {
            document.getElementById('notificationCenter').style.display = 'none';
        });
    }

    setupImportSystem() {
        const fileInput = document.getElementById('csvFileInput');
        const uploadZone = document.getElementById('csvUploadZone');
        const selectButton = document.getElementById('selectCsvFile');

        // File selection
        selectButton?.addEventListener('click', () => fileInput?.click());
        
        fileInput?.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                this.handleCsvFile(e.target.files[0]);
            }
        });

        // Drag and drop
        uploadZone?.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone?.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone?.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                this.handleCsvFile(e.dataTransfer.files[0]);
            }
        });

        // Import steps navigation
        document.getElementById('nextStep')?.addEventListener('click', () => {
            this.nextImportStep();
        });

        document.getElementById('prevStep')?.addEventListener('click', () => {
            this.prevImportStep();
        });

        document.getElementById('startImport')?.addEventListener('click', () => {
            this.startCsvImport();
        });
    }

    setupSecurityAudit() {
        document.getElementById('downloadSecurityReport')?.addEventListener('click', () => {
            this.downloadSecurityReport();
        });

        document.getElementById('fixSecurityIssues')?.addEventListener('click', () => {
            this.fixSecurityIssues();
        });
    }

    // Notification methods
    checkForNotifications() {
        // Simulate checking for new notifications
        const hasNewNotifications = Math.random() > 0.7;
        if (hasNewNotifications) {
            this.showNotification();
        }
    }

    showNotification() {
        const notificationCenter = document.getElementById('notificationCenter');
        if (notificationCenter) {
            notificationCenter.style.display = 'block';
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                notificationCenter.style.display = 'none';
            }, 10000);
        }
    }

    // Import methods
    handleCsvFile(file) {
        if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
            this.showNotification('Vui lòng chọn file CSV hợp lệ!', 'error');
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            this.csvData = e.target.result;
            this.showImportStep(2);
            this.processCsvPreview();
        };
        reader.readAsText(file);
    }

    processCsvPreview() {
        const lines = this.csvData.split('\n');
        const headers = lines[0].split(',');
        
        // Create column mapping interface
        const mappingDiv = document.getElementById('columnMapping');
        mappingDiv.innerHTML = '';
        
        headers.forEach((header, index) => {
            const div = document.createElement('div');
            div.className = 'form-group';
            div.innerHTML = `
                <label>${header.trim()}</label>
                <select class="form-control column-map" data-index="${index}">
                    <option value="">-- Bỏ qua --</option>
                    <option value="ten_nguoi_dung" ${header.includes('name') || header.includes('username') ? 'selected' : ''}>Tên người dùng</option>
                    <option value="email" ${header.includes('email') ? 'selected' : ''}>Email</option>
                    <option value="vai_tro" ${header.includes('role') ? 'selected' : ''}>Vai trò</option>
                </select>
            `;
            mappingDiv.appendChild(div);
        });
    }

    showImportStep(step) {
        document.querySelectorAll('.step').forEach(s => {
            s.style.display = 'none';
            s.classList.remove('active');
        });
        
        const targetStep = document.querySelector(`[data-step="${step}"]`);
        if (targetStep) {
            targetStep.style.display = 'block';
            targetStep.classList.add('active');
        }

        // Update navigation buttons
        const prevBtn = document.getElementById('prevStep');
        const nextBtn = document.getElementById('nextStep');
        const importBtn = document.getElementById('startImport');

        prevBtn.style.display = step > 1 ? 'inline-block' : 'none';
        nextBtn.style.display = step < 3 ? 'inline-block' : 'none';
        importBtn.style.display = step === 3 ? 'inline-block' : 'none';

        this.currentImportStep = step;
    }

    nextImportStep() {
        if (this.currentImportStep < 3) {
            this.currentImportStep++;
            this.showImportStep(this.currentImportStep);
            
            if (this.currentImportStep === 3) {
                this.generateImportPreview();
            }
        }
    }

    prevImportStep() {
        if (this.currentImportStep > 1) {
            this.currentImportStep--;
            this.showImportStep(this.currentImportStep);
        }
    }

    generateImportPreview() {
        const lines = this.csvData.split('\n').slice(1, 6); // First 5 rows for preview
        const mapping = {};
        
        document.querySelectorAll('.column-map').forEach(select => {
            const index = select.getAttribute('data-index');
            const field = select.value;
            if (field) {
                mapping[index] = field;
            }
        });

        const previewDiv = document.getElementById('importPreview');
        let previewHtml = '<h6>Xem trước dữ liệu import (5 dòng đầu):</h6><div class="table-responsive"><table class="table table-sm table-bordered"><thead><tr>';
        
        Object.values(mapping).forEach(field => {
            previewHtml += `<th>${field}</th>`;
        });
        previewHtml += '</tr></thead><tbody>';

        lines.forEach(line => {
            const cells = line.split(',');
            previewHtml += '<tr>';
            Object.keys(mapping).forEach(index => {
                previewHtml += `<td>${cells[index]?.trim() || ''}</td>`;
            });
            previewHtml += '</tr>';
        });

        previewHtml += '</tbody></table></div>';
        previewDiv.innerHTML = previewHtml;
    }

    startCsvImport() {
        const progressModal = this.createProgressModal('Đang import người dùng...');
        document.body.appendChild(progressModal);
        
        // Simulate import process
        let progress = 0;
        const interval = setInterval(() => {
            progress += 10;
            this.updateProgress(progressModal, progress);
            
            if (progress >= 100) {
                clearInterval(interval);
                setTimeout(() => {
                    progressModal.remove();
                    $('#importUsersModal').modal('hide');
                    this.showNotification('Import thành công!', 'success');
                    window.location.reload();
                }, 1000);
            }
        }, 200);
    }

    // Security methods
    runSecurityAudit() {
        // Simulate security audit
        console.log('Running security audit...');
    }

    downloadSecurityReport() {
        const reportData = {
            timestamp: new Date().toISOString(),
            score: 98,
            issues: [
                { type: 'warning', description: '2 tài khoản chưa đổi mật khẩu mặc định' }
            ]
        };
        
        const blob = new Blob([JSON.stringify(reportData, null, 2)], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `security-report-${new Date().toISOString().slice(0, 10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }

    fixSecurityIssues() {
        const progressModal = this.createProgressModal('Đang sửa các vấn đề bảo mật...');
        document.body.appendChild(progressModal);
        
        let progress = 0;
        const interval = setInterval(() => {
            progress += 20;
            this.updateProgress(progressModal, progress);
            
            if (progress >= 100) {
                clearInterval(interval);
                setTimeout(() => {
                    progressModal.remove();
                    this.showNotification('Đã sửa xong các vấn đề bảo mật!', 'success');
                }, 1000);
            }
        }, 500);
    }

    // Utility methods
    createProgressModal(title) {
        const modal = document.createElement('div');
        modal.className = 'modal fade show';
        modal.style.display = 'block';
        modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
        modal.innerHTML = `
            <div class="modal-dialog modal-sm">
                <div class="modal-content">
                    <div class="modal-body text-center">
                        <h6>${title}</h6>
                        <div class="progress mt-3">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="progress-text mt-2">0%</div>
                    </div>
                </div>
            </div>
        `;
        return modal;
    }

    updateProgress(modal, progress) {
        const progressBar = modal.querySelector('.progress-bar');
        const progressText = modal.querySelector('.progress-text');        progressBar.style.width = progress + '%';
        progressText.textContent = progress + '%';
    }

    generateAdvancedReport() {
        // Implementation for advanced reporting
        this.showNotification('Đang tạo báo cáo chi tiết...', 'info');
        
        setTimeout(() => {
            const reportData = this.getReportData();
            this.exportToPDF(reportData);
            this.showNotification('Báo cáo đã được tạo và tải xuống!', 'success');
        }, 2000);
    }

    getReportData() {
        return [{
            name: 'User Management Report',
            totalUsers: document.getElementById('totalUsers').textContent,
            activeUsers: document.getElementById('activeUsers').textContent,
            adminUsers: document.getElementById('adminUsers').textContent,
            onlineUsers: document.getElementById('onlineUsers').textContent,
            generatedAt: new Date().toLocaleString()
        }];
    }

    showSystemCleanupDialog() {
        const confirmed = confirm('Bạn có chắc muốn dọn dẹp hệ thống? Thao tác này sẽ:\n' +
            '- Xóa các phiên đăng nhập hết hạn\n' +
            '- Dọn dẹp log cũ\n' +
            '- Tối ưu hóa cơ sở dữ liệu');
        
        if (confirmed) {
            const progressModal = this.createProgressModal('Đang dọn dẹp hệ thống...');
            document.body.appendChild(progressModal);
            
            let progress = 0;
            const interval = setInterval(() => {
                progress += 15;
                this.updateProgress(progressModal, progress);
                
                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        progressModal.remove();
                        this.showNotification('Dọn dẹp hệ thống hoàn tất!', 'success');
                    }, 1000);
                }
            }, 300);
        }
    }
}

// Global functions
function sendMessage(userId) {
    // Implementation for sending message to user
    console.log(`Send message to user ${userId}`);
}

function deleteUser(userId) {
    // Get CSRF token
    fetch('{{ url_for("admin.get_csrf_token") }}')
        .then(response => response.json())
        .then(data => {
            // Make delete request
            fetch(`{{ url_for("admin.delete_user", user_id=0) }}`.replace('0', userId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': data.csrf_token
                }
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Close modal
                    $(`#deleteModal${userId}`).modal('hide');
                    
                    // Show success message
                    showNotification(result.message, 'success');
                    
                    // Remove user row from table
                    $(`tr[data-user-id="${userId}"]`).fadeOut(300, function() {
                        $(this).remove();
                        updateUserStats();
                    });
                } else {
                    showNotification(result.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error deleting user:', error);
                showNotification('Có lỗi xảy ra khi xóa người dùng.', 'error');
            });
        })
        .catch(error => {
            console.error('Error getting CSRF token:', error);
            showNotification('Có lỗi xảy ra. Vui lòng thử lại.', 'error');
        });
}

function updateUserStats() {
    // Update statistics after user deletion
    const remainingUsers = document.querySelectorAll('.user-row').length;
    document.getElementById('totalUsers').textContent = remainingUsers;
    
    // Update other stats as needed
    const activeUsers = document.querySelectorAll('.user-row .status-online').length;
    document.getElementById('activeUsers').textContent = activeUsers;
}

function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
    notification.style.position = 'fixed';
    notification.style.top = '20px';
    notification.style.right = '20px';
    notification.style.zIndex = '9999';
    notification.style.minWidth = '300px';
    
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} mr-2"></i>
        ${message}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Initialize user management
let userMgmt;
document.addEventListener('DOMContentLoaded', function() {
    userMgmt = new UserManagement();
});
</script>
{% endblock %}






