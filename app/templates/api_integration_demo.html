{% extends "base.html" %}

{% block title %}API Integration Demo - CSRF{% endblock %}

{% block extra_css %}
<style>
    .api-section {
        background: #f8f9fa;
        border-left: 4px solid #007bff;
        padding: 1.5rem;
        margin-bottom: 2rem;
        border-radius: 0 0.5rem 0.5rem 0;
    }
    .endpoint-card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
        overflow: hidden;
    }
    .endpoint-header {
        background: #007bff;
        color: white;
        padding: 0.75rem 1rem;
        font-weight: bold;
        display: flex;
        justify-content: between;
        align-items: center;
    }
    .method-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: bold;
        margin-right: 0.5rem;
    }
    .method-get { background: #28a745; color: white; }
    .method-post { background: #007bff; color: white; }
    .method-put { background: #ffc107; color: black; }
    .method-delete { background: #dc3545; color: white; }
    
    .request-builder {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        padding: 1rem;
        margin: 1rem 0;
    }
    
    .response-viewer {
        background: #2d3748;
        color: #e2e8f0;
        padding: 1rem;
        border-radius: 0.5rem;
        font-family: 'Courier New', monospace;
        font-size: 0.875rem;
        max-height: 400px;
        overflow-y: auto;
        white-space: pre-wrap;
    }
    
    .status-success { color: #28a745; }
    .status-error { color: #dc3545; }
    .status-warning { color: #ffc107; }
    
    .curl-command {
        background: #343a40;
        color: #f8f9fa;
        padding: 1rem;
        border-radius: 0.5rem;
        font-family: 'Courier New', monospace;
        font-size: 0.875rem;
        word-break: break-all;
        margin: 1rem 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h2">üîå API Integration Demo with CSRF</h1>
                <div>
                    <button class="btn btn-outline-info" onclick="showApiDocs()">
                        üìö API Documentation
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- API Overview -->
    <div class="api-section">
        <h3>üéØ Available CSRF API Endpoints</h3>
        <p class="text-muted">Test all CSRF-related API endpoints and see real-time responses.</p>
        
        <div class="row">
            <div class="col-md-6">
                <!-- Get CSRF Token -->
                <div class="endpoint-card">
                    <div class="endpoint-header">
                        <div>
                            <span class="method-badge method-get">GET</span>
                            /api/v1/csrf-token
                        </div>
                        <button class="btn btn-sm btn-light" onclick="testEndpoint('GET', '/api/v1/csrf-token')">
                            Test
                        </button>
                    </div>
                    <div class="p-3">
                        <p class="mb-2"><strong>Description:</strong> Get a fresh CSRF token</p>
                        <p class="mb-2"><strong>Auth Required:</strong> No</p>
                        <p class="mb-0"><strong>Returns:</strong> JSON with csrf_token, timestamp, expires_in</p>
                    </div>
                </div>

                <!-- Refresh CSRF Token -->
                <div class="endpoint-card">
                    <div class="endpoint-header">
                        <div>
                            <span class="method-badge method-post">POST</span>
                            /api/v1/csrf-token/refresh
                        </div>
                        <button class="btn btn-sm btn-light" onclick="testEndpoint('POST', '/api/v1/csrf-token/refresh')">
                            Test
                        </button>
                    </div>
                    <div class="p-3">
                        <p class="mb-2"><strong>Description:</strong> Force refresh CSRF token</p>
                        <p class="mb-2"><strong>Auth Required:</strong> Yes (login required)</p>
                        <p class="mb-0"><strong>Returns:</strong> JSON with new csrf_token and refreshed flag</p>
                    </div>
                </div>

                <!-- Validate CSRF Token -->
                <div class="endpoint-card">
                    <div class="endpoint-header">
                        <div>
                            <span class="method-badge method-post">POST</span>
                            /api/v1/csrf-token/validate
                        </div>
                        <button class="btn btn-sm btn-light" onclick="testEndpoint('POST', '/api/v1/csrf-token/validate')">
                            Test
                        </button>
                    </div>
                    <div class="p-3">
                        <p class="mb-2"><strong>Description:</strong> Validate current CSRF token</p>
                        <p class="mb-2"><strong>Auth Required:</strong> No</p>
                        <p class="mb-0"><strong>Headers:</strong> X-CSRFToken required</p>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <!-- Legacy Endpoints -->
                <div class="endpoint-card">
                    <div class="endpoint-header">
                        <div>
                            <span class="method-badge method-get">GET</span>
                            /csrf-token
                        </div>
                        <button class="btn btn-sm btn-light" onclick="testEndpoint('GET', '/csrf-token')">
                            Test
                        </button>
                    </div>
                    <div class="p-3">
                        <p class="mb-2"><strong>Description:</strong> User route CSRF token</p>
                        <p class="mb-2"><strong>Auth Required:</strong> Yes</p>
                        <p class="mb-0"><strong>Legacy:</strong> For backward compatibility</p>
                    </div>
                </div>

                <div class="endpoint-card">
                    <div class="endpoint-header">
                        <div>
                            <span class="method-badge method-get">GET</span>
                            /admin/csrf-token
                        </div>
                        <button class="btn btn-sm btn-light" onclick="testEndpoint('GET', '/admin/csrf-token')">
                            Test
                        </button>
                    </div>
                    <div class="p-3">
                        <p class="mb-2"><strong>Description:</strong> Admin route CSRF token</p>
                        <p class="mb-2"><strong>Auth Required:</strong> Yes (admin)</p>
                        <p class="mb-0"><strong>Legacy:</strong> For admin forms</p>
                    </div>
                </div>

                <div class="endpoint-card">
                    <div class="endpoint-header">
                        <div>
                            <span class="method-badge method-get">GET</span>
                            /lab/csrf-token
                        </div>
                        <button class="btn btn-sm btn-light" onclick="testEndpoint('GET', '/lab/csrf-token')">
                            Test
                        </button>
                    </div>
                    <div class="p-3">
                        <p class="mb-2"><strong>Description:</strong> Lab route CSRF token</p>
                        <p class="mb-2"><strong>Auth Required:</strong> Yes</p>
                        <p class="mb-0"><strong>Legacy:</strong> For lab forms</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Request Builder -->
        <div class="col-lg-6">
            <div class="api-section">
                <h4>üõ†Ô∏è Custom Request Builder</h4>
                
                <div class="request-builder">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Method:</label>
                            <select class="form-select" id="requestMethod">
                                <option value="GET">GET</option>
                                <option value="POST">POST</option>
                                <option value="PUT">PUT</option>
                                <option value="DELETE">DELETE</option>
                            </select>
                        </div>
                        <div class="col-md-8">
                            <label class="form-label">Endpoint:</label>
                            <input type="text" class="form-control" id="requestEndpoint" 
                                   value="/api/v1/csrf-token" placeholder="/api/v1/endpoint">
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <label class="form-label">Headers (JSON format):</label>
                        <textarea class="form-control" id="requestHeaders" rows="3">{
  "Content-Type": "application/json"
}</textarea>
                    </div>
                    
                    <div class="mt-3">
                        <label class="form-label">Request Body (JSON format):</label>
                        <textarea class="form-control" id="requestBody" rows="4">{
  "test_data": "Custom API request"
}</textarea>
                    </div>
                    
                    <div class="mt-3 d-flex gap-2">
                        <button class="btn btn-primary" onclick="sendCustomRequest()">
                            üöÄ Send Request
                        </button>
                        <button class="btn btn-outline-secondary" onclick="addCSRFHeader()">
                            üîë Add CSRF Token
                        </button>
                        <button class="btn btn-outline-info" onclick="generateCurl()">
                            üìã Generate cURL
                        </button>
                    </div>
                </div>
            </div>

            <!-- cURL Generator -->
            <div class="api-section">
                <h4>üíª cURL Command</h4>
                <div class="curl-command" id="curlCommand">
                    # Click "Generate cURL" to see the command
                </div>
                <button class="btn btn-sm btn-outline-secondary" onclick="copyCurl()">
                    üìã Copy to Clipboard
                </button>
            </div>
        </div>

        <!-- Response Viewer -->
        <div class="col-lg-6">
            <div class="api-section">
                <h4>üìä Response Viewer</h4>
                
                <!-- Response Status -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <span class="badge bg-secondary" id="responseStatus">No requests yet</span>
                        <span class="badge bg-info" id="responseTime">0ms</span>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearResponse()">
                            üóëÔ∏è Clear
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="saveResponse()">
                            üíæ Save
                        </button>
                    </div>
                </div>
                
                <!-- Response Headers -->
                <div class="mb-3">
                    <h6>Response Headers:</h6>
                    <div class="response-viewer" id="responseHeaders" style="max-height: 150px;">
                        No response headers yet
                    </div>
                </div>
                
                <!-- Response Body -->
                <div>
                    <h6>Response Body:</h6>
                    <div class="response-viewer" id="responseBody">
                        No response body yet
                    </div>
                </div>
            </div>

            <!-- Request History -->
            <div class="api-section">
                <h4>üìö Request History</h4>
                <div id="requestHistory" class="list-group" style="max-height: 300px; overflow-y: auto;">
                    <div class="list-group-item text-muted">
                        No requests in history yet
                    </div>
                </div>
                <div class="mt-2">
                    <button class="btn btn-sm btn-outline-secondary" onclick="clearHistory()">
                        üóëÔ∏è Clear History
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="exportHistory()">
                        üìÑ Export History
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- API Documentation Modal -->
    <div class="modal fade" id="apiDocsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üìö CSRF API Documentation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6>Authentication</h6>
                    <p>Some endpoints require authentication. Make sure you're logged in for protected routes.</p>
                    
                    <h6>CSRF Token Usage</h6>
                    <ul>
                        <li>Include CSRF token in <code>X-CSRFToken</code> header</li>
                        <li>Or include as <code>csrf_token</code> in form data</li>
                        <li>Tokens are valid for 1 hour by default</li>
                        <li>API routes (/api/*) are exempt from CSRF protection</li>
                    </ul>
                    
                    <h6>Response Formats</h6>
                    <p>All responses are in JSON format with standard structure:</p>
                    <pre><code>{
  "csrf_token": "token_value",
  "timestamp": "2024-01-01T12:00:00",
  "expires_in": 3600
}</code></pre>
                    
                    <h6>Error Handling</h6>
                    <p>Errors return appropriate HTTP status codes with JSON error messages:</p>
                    <pre><code>{
  "error": "Error description",
  "message": "User-friendly message"
}</code></pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let requestHistory = [];

document.addEventListener('DOMContentLoaded', function() {
    // Initialize with current CSRF token if available
    if (window.labAPI && window.labAPI.csrfToken) {
        updateHeadersWithCSRF();
    }
});

async function testEndpoint(method, endpoint) {
    const startTime = Date.now();
    
    try {
        let options = {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            }
        };
        
        // Add CSRF token for POST requests
        if (method !== 'GET' && window.labAPI && window.labAPI.csrfToken) {
            options.headers['X-CSRFToken'] = window.labAPI.csrfToken;
        }
        
        const response = await fetch(endpoint, options);
        const endTime = Date.now();
        const responseTime = endTime - startTime;
        
        // Get response headers
        const headers = {};
        response.headers.forEach((value, key) => {
            headers[key] = value;
        });
        
        // Get response body
        let responseBody;
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            responseBody = await response.json();
        } else {
            responseBody = await response.text();
        }
        
        // Update UI
        updateResponseDisplay(response.status, responseTime, headers, responseBody);
        
        // Add to history
        addToHistory(method, endpoint, response.status, responseTime);
        
    } catch (error) {
        const endTime = Date.now();
        const responseTime = endTime - startTime;
        
        updateResponseDisplay('ERROR', responseTime, {}, {
            error: error.message,
            message: 'Request failed'
        });
        
        addToHistory(method, endpoint, 'ERROR', responseTime);
    }
}

async function sendCustomRequest() {
    const method = document.getElementById('requestMethod').value;
    const endpoint = document.getElementById('requestEndpoint').value;
    const headersText = document.getElementById('requestHeaders').value;
    const bodyText = document.getElementById('requestBody').value;
    
    const startTime = Date.now();
    
    try {
        // Parse headers
        let headers = {};
        try {
            headers = JSON.parse(headersText);
        } catch (e) {
            throw new Error('Invalid JSON in headers field');
        }
        
        // Prepare request options
        let options = {
            method: method,
            headers: headers
        };
        
        // Add body for non-GET requests
        if (method !== 'GET' && bodyText.trim()) {
            try {
                options.body = JSON.stringify(JSON.parse(bodyText));
            } catch (e) {
                options.body = bodyText; // Use as-is if not valid JSON
            }
        }
        
        const response = await fetch(endpoint, options);
        const endTime = Date.now();
        const responseTime = endTime - startTime;
        
        // Get response headers
        const responseHeaders = {};
        response.headers.forEach((value, key) => {
            responseHeaders[key] = value;
        });
        
        // Get response body
        let responseBody;
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            responseBody = await response.json();
        } else {
            responseBody = await response.text();
        }
        
        // Update UI
        updateResponseDisplay(response.status, responseTime, responseHeaders, responseBody);
        addToHistory(method, endpoint, response.status, responseTime);
        
    } catch (error) {
        const endTime = Date.now();
        const responseTime = endTime - startTime;
        
        updateResponseDisplay('ERROR', responseTime, {}, {
            error: error.message,
            message: 'Custom request failed'
        });
        
        addToHistory(method, endpoint, 'ERROR', responseTime);
    }
}

function updateResponseDisplay(status, responseTime, headers, body) {
    // Update status
    const statusElement = document.getElementById('responseStatus');
    statusElement.textContent = status;
    statusElement.className = `badge ${getStatusClass(status)}`;
    
    // Update response time
    document.getElementById('responseTime').textContent = `${responseTime}ms`;
    
    // Update headers
    document.getElementById('responseHeaders').textContent = JSON.stringify(headers, null, 2);
    
    // Update body
    const bodyText = typeof body === 'object' ? JSON.stringify(body, null, 2) : body;
    document.getElementById('responseBody').textContent = bodyText;
}

function getStatusClass(status) {
    if (status === 'ERROR') return 'bg-danger';
    if (status >= 200 && status < 300) return 'bg-success';
    if (status >= 300 && status < 400) return 'bg-info';
    if (status >= 400 && status < 500) return 'bg-warning';
    if (status >= 500) return 'bg-danger';
    return 'bg-secondary';
}

function addToHistory(method, endpoint, status, responseTime) {
    const historyItem = {
        timestamp: new Date().toLocaleTimeString(),
        method: method,
        endpoint: endpoint,
        status: status,
        responseTime: responseTime
    };
    
    requestHistory.unshift(historyItem);
    
    // Keep only last 20 requests
    if (requestHistory.length > 20) {
        requestHistory = requestHistory.slice(0, 20);
    }
    
    updateHistoryDisplay();
}

function updateHistoryDisplay() {
    const historyElement = document.getElementById('requestHistory');
    
    if (requestHistory.length === 0) {
        historyElement.innerHTML = '<div class="list-group-item text-muted">No requests in history yet</div>';
        return;
    }
    
    const historyHtml = requestHistory.map(item => `
        <div class="list-group-item d-flex justify-content-between align-items-center">
            <div>
                <span class="badge ${getMethodBadgeClass(item.method)}">${item.method}</span>
                <span class="ms-2">${item.endpoint}</span>
            </div>
            <div>
                <span class="badge ${getStatusClass(item.status)}">${item.status}</span>
                <small class="text-muted ms-2">${item.responseTime}ms</small>
                <small class="text-muted ms-2">${item.timestamp}</small>
            </div>
        </div>
    `).join('');
    
    historyElement.innerHTML = historyHtml;
}

function getMethodBadgeClass(method) {
    switch (method) {
        case 'GET': return 'bg-success';
        case 'POST': return 'bg-primary';
        case 'PUT': return 'bg-warning';
        case 'DELETE': return 'bg-danger';
        default: return 'bg-secondary';
    }
}

async function addCSRFHeader() {
    if (!window.labAPI) {
        alert('LabManagerAPI not available');
        return;
    }
    
    await window.labAPI.refreshCSRFToken();
    
    if (!window.labAPI.csrfToken) {
        alert('Could not get CSRF token');
        return;
    }
    
    const headersField = document.getElementById('requestHeaders');
    try {
        const headers = JSON.parse(headersField.value);
        headers['X-CSRFToken'] = window.labAPI.csrfToken;
        headersField.value = JSON.stringify(headers, null, 2);
        
        alert('CSRF token added to headers');
    } catch (e) {
        alert('Invalid JSON in headers field');
    }
}

function updateHeadersWithCSRF() {
    if (window.labAPI && window.labAPI.csrfToken) {
        const headersField = document.getElementById('requestHeaders');
        try {
            const headers = JSON.parse(headersField.value);
            headers['X-CSRFToken'] = window.labAPI.csrfToken;
            headersField.value = JSON.stringify(headers, null, 2);
        } catch (e) {
            // Ignore if headers field has invalid JSON
        }
    }
}

function generateCurl() {
    const method = document.getElementById('requestMethod').value;
    const endpoint = document.getElementById('requestEndpoint').value;
    const headersText = document.getElementById('requestHeaders').value;
    const bodyText = document.getElementById('requestBody').value;
    
    let curl = `curl -X ${method}`;
    
    // Add headers
    try {
        const headers = JSON.parse(headersText);
        Object.entries(headers).forEach(([key, value]) => {
            curl += ` \\\n  -H "${key}: ${value}"`;
        });
    } catch (e) {
        // Ignore invalid JSON
    }
    
    // Add body for non-GET requests
    if (method !== 'GET' && bodyText.trim()) {
        curl += ` \\\n  -d '${bodyText.replace(/'/g, "\\'")}`;
    }
    
    // Add URL
    const fullUrl = endpoint.startsWith('http') ? endpoint : `${window.location.origin}${endpoint}`;
    curl += ` \\\n  "${fullUrl}"`;
    
    document.getElementById('curlCommand').textContent = curl;
}

function copyCurl() {
    const curlText = document.getElementById('curlCommand').textContent;
    navigator.clipboard.writeText(curlText).then(function() {
        alert('cURL command copied to clipboard!');
    });
}

function clearResponse() {
    document.getElementById('responseStatus').textContent = 'No requests yet';
    document.getElementById('responseStatus').className = 'badge bg-secondary';
    document.getElementById('responseTime').textContent = '0ms';
    document.getElementById('responseHeaders').textContent = 'No response headers yet';
    document.getElementById('responseBody').textContent = 'No response body yet';
}

function clearHistory() {
    requestHistory = [];
    updateHistoryDisplay();
}

function saveResponse() {
    const status = document.getElementById('responseStatus').textContent;
    const headers = document.getElementById('responseHeaders').textContent;
    const body = document.getElementById('responseBody').textContent;
    
    const responseData = {
        status: status,
        headers: headers,
        body: body,
        timestamp: new Date().toISOString()
    };
    
    const blob = new Blob([JSON.stringify(responseData, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `api-response-${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function exportHistory() {
    const blob = new Blob([JSON.stringify(requestHistory, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `api-request-history-${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function showApiDocs() {
    const modal = new bootstrap.Modal(document.getElementById('apiDocsModal'));
    modal.show();
}
</script>
{% endblock %}
