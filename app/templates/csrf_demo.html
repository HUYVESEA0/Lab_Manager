{% extends "base.html" %}

{% block title %}CSRF Demo - Lab Manager{% endblock %}

{% block extra_css %}
<style>
    .demo-section {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    .demo-section h4 {
        color: #495057;
        margin-bottom: 1rem;
        border-bottom: 2px solid #007bff;
        padding-bottom: 0.5rem;
    }
    .code-block {
        background: #2d3748;
        color: #e2e8f0;
        padding: 1rem;
        border-radius: 0.375rem;
        font-family: 'Courier New', monospace;
        font-size: 0.875rem;
        margin: 1rem 0;
        overflow-x: auto;
    }
    .result-box {
        background: #fff;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        margin: 1rem 0;
        min-height: 100px;
    }
    .success { border-left: 4px solid #28a745; background-color: #d4edda; }
    .error { border-left: 4px solid #dc3545; background-color: #f8d7da; }
    .info { border-left: 4px solid #17a2b8; background-color: #d1ecf1; }
    .warning { border-left: 4px solid #ffc107; background-color: #fff3cd; }
    
    .demo-button {
        margin: 0.5rem;
        min-width: 120px;
    }
    
    .token-display {
        font-family: monospace;
        font-size: 0.8rem;
        word-break: break-all;
        background: #f1f3f4;
        padding: 0.5rem;
        border-radius: 0.25rem;
        border: 1px solid #dadce0;
    }
    
    .demo-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin: 1rem 0;
    }
    
    .stat-card {
        background: white;
        padding: 1rem;
        border-radius: 0.5rem;
        border: 1px solid #dee2e6;
        text-align: center;
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: #007bff;
    }
    
    .stat-label {
        color: #6c757d;
        font-size: 0.875rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h2">🛡️ CSRF Protection Demo</h1>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" onclick="resetDemo()">
                        🔄 Reset Demo
                    </button>
                    <button class="btn btn-outline-success" onclick="runAllTests()">
                        🧪 Run All Tests
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Dashboard -->
    <div class="demo-section">
        <h4>📊 Demo Statistics</h4>
        <div class="demo-stats">
            <div class="stat-card">
                <div class="stat-number" id="tokenCount">0</div>
                <div class="stat-label">Tokens Generated</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="requestCount">0</div>
                <div class="stat-label">Requests Made</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="successCount">0</div>
                <div class="stat-label">Successful</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="errorCount">0</div>
                <div class="stat-label">Errors</div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Column: Token Management -->
        <div class="col-lg-6">
            <!-- Current Token Display -->
            <div class="demo-section">
                <h4>🔑 Current CSRF Token</h4>
                <div class="token-display" id="currentTokenDisplay">
                    Loading token...
                </div>
                <small class="text-muted d-block mt-2">
                    Last updated: <span id="tokenTimestamp">Never</span>
                </small>
                
                <div class="mt-3">
                    <button class="btn btn-primary demo-button" onclick="refreshToken()">
                        🔄 Refresh Token
                    </button>
                    <button class="btn btn-info demo-button" onclick="validateCurrentToken()">
                        ✅ Validate Token
                    </button>
                    <button class="btn btn-warning demo-button" onclick="expireToken()">
                        ⏰ Expire Token
                    </button>
                </div>
            </div>

            <!-- Token Generation Demo -->
            <div class="demo-section">
                <h4>⚙️ Token Generation Methods</h4>
                <p class="text-muted">Test different ways to obtain CSRF tokens:</p>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="getTokenFromAPI()">
                        📡 Get from API (/api/v1/csrf-token)
                    </button>
                    <button class="btn btn-outline-primary" onclick="getTokenFromUser()">
                        👤 Get from User endpoint (/csrf-token)
                    </button>
                    <button class="btn btn-outline-primary" onclick="getTokenFromAdmin()">
                        🛠️ Get from Admin endpoint (/admin/csrf-token)
                    </button>
                    <button class="btn btn-outline-primary" onclick="getTokenFromLab()">
                        🧪 Get from Lab endpoint (/lab/csrf-token)
                    </button>
                </div>
            </div>

            <!-- Security Tests -->
            <div class="demo-section">
                <h4>🔒 Security Tests</h4>
                <p class="text-muted">Test CSRF protection mechanisms:</p>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-danger" onclick="testWithoutToken()">
                        ❌ Request without CSRF token (should fail)
                    </button>
                    <button class="btn btn-outline-danger" onclick="testWithInvalidToken()">
                        🚫 Request with invalid token (should fail)
                    </button>
                    <button class="btn btn-outline-success" onclick="testWithValidToken()">
                        ✅ Request with valid token (should succeed)
                    </button>
                    <button class="btn btn-outline-warning" onclick="testTokenReuse()">
                        🔄 Test token reuse (security check)
                    </button>
                </div>
            </div>
        </div>

        <!-- Right Column: Results and Forms -->
        <div class="col-lg-6">
            <!-- Test Results -->
            <div class="demo-section">
                <h4>📋 Test Results</h4>
                <div class="result-box" id="testResults">
                    <p class="text-muted">Test results will appear here...</p>
                </div>
                <div class="mt-2">
                    <button class="btn btn-sm btn-outline-secondary" onclick="clearResults()">
                        🗑️ Clear Results
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="exportResults()">
                        📄 Export Results
                    </button>
                </div>
            </div>

            <!-- Form Testing -->
            <div class="demo-section">
                <h4>📝 Form Submission Tests</h4>
                
                <!-- Test Form 1: Standard Form -->
                <div class="card mb-3">
                    <div class="card-header">
                        <strong>Standard Form (with CSRF protection)</strong>
                    </div>
                    <div class="card-body">
                        <form id="testForm1" method="POST" action="/csrf-test">
                            {{ csrf_token() }}
                            <div class="mb-3">
                                <label for="testData1" class="form-label">Test Data:</label>
                                <input type="text" class="form-control" id="testData1" name="test_data" 
                                       value="Standard form test" required>
                            </div>
                            <button type="submit" class="btn btn-success">Submit Standard Form</button>
                        </form>
                    </div>
                </div>

                <!-- Test Form 2: AJAX Form -->
                <div class="card mb-3">
                    <div class="card-header">
                        <strong>AJAX Form (JavaScript submission)</strong>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="ajaxData" class="form-label">AJAX Test Data:</label>
                            <input type="text" class="form-control" id="ajaxData" 
                                   value="AJAX form test" required>
                        </div>
                        <button type="button" class="btn btn-info" onclick="submitAjaxForm()">
                            Submit via AJAX
                        </button>
                    </div>
                </div>

                <!-- Test Form 3: File Upload -->
                <div class="card">
                    <div class="card-header">
                        <strong>File Upload Form (multipart/form-data)</strong>
                    </div>
                    <div class="card-body">
                        <form id="uploadForm" method="POST" action="/csrf-test" enctype="multipart/form-data">
                            {{ csrf_token() }}
                            <div class="mb-3">
                                <label for="testFile" class="form-label">Test File:</label>
                                <input type="file" class="form-control" id="testFile" name="test_file">
                            </div>
                            <div class="mb-3">
                                <label for="uploadData" class="form-label">Additional Data:</label>
                                <input type="text" class="form-control" id="uploadData" name="upload_data"
                                       value="File upload test">
                            </div>
                            <button type="submit" class="btn btn-warning">Submit File Upload</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Code Examples -->
    <div class="demo-section">
        <h4>💻 Code Examples</h4>
        <div class="row">
            <div class="col-md-6">
                <h6>JavaScript - Get CSRF Token:</h6>
                <div class="code-block">
// Using LabManagerAPI
const token = await window.labAPI.refreshCSRFToken();

// Manual API call
const response = await fetch('/api/v1/csrf-token');
const data = await response.json();
const csrfToken = data.csrf_token;
                </div>
            </div>
            <div class="col-md-6">
                <h6>JavaScript - Submit Form with CSRF:</h6>
                <div class="code-block">
// Automatic with LabManagerAPI
await window.labAPI.submitForm(formElement);

// Manual with fetch
fetch('/endpoint', {
    method: 'POST',
    headers: {
        'X-CSRFToken': csrfToken,
        'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
});
                </div>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-md-6">
                <h6>Python Flask - Generate Token:</h6>
                <div class="code-block">
from flask_wtf.csrf import generate_csrf

@app.route('/csrf-token')
def get_csrf_token():
    return jsonify({
        'csrf_token': generate_csrf(),
        'timestamp': datetime.now().isoformat()
    })
                </div>
            </div>
            <div class="col-md-6">
                <h6>HTML - Include CSRF in Form:</h6>
                <div class="code-block">
&lt;form method="POST"&gt;
    {{ csrf_token() }}
    &lt;!-- or --&gt;
    &lt;input type="hidden" name="csrf_token" 
           value="{{ csrf_token() }}"/&gt;
    &lt;!-- form fields --&gt;
&lt;/form&gt;
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Demo statistics
let stats = {
    tokenCount: 0,
    requestCount: 0,
    successCount: 0,
    errorCount: 0
};

// Initialize demo
document.addEventListener('DOMContentLoaded', function() {
    updateTokenDisplay();
    updateStats();
    
    // Set up form handlers
    setupFormHandlers();
    
    // Auto-refresh token display every 30 seconds
    setInterval(updateTokenDisplay, 30000);
});

function updateStats() {
    document.getElementById('tokenCount').textContent = stats.tokenCount;
    document.getElementById('requestCount').textContent = stats.requestCount;
    document.getElementById('successCount').textContent = stats.successCount;
    document.getElementById('errorCount').textContent = stats.errorCount;
}

function incrementStat(statName) {
    stats[statName]++;
    updateStats();
}

async function updateTokenDisplay() {
    try {
        if (window.labAPI && window.labAPI.csrfToken) {
            document.getElementById('currentTokenDisplay').textContent = window.labAPI.csrfToken;
            if (window.labAPI.csrfTokenTimestamp) {
                document.getElementById('tokenTimestamp').textContent = 
                    new Date(window.labAPI.csrfTokenTimestamp).toLocaleString();
            }
        } else {
            document.getElementById('currentTokenDisplay').textContent = 'No token available';
        }
    } catch (error) {
        addResult('Token Display Update', 'ERROR', error.message);
    }
}

async function refreshToken() {
    try {
        await window.labAPI.refreshCSRFToken(true);
        incrementStat('tokenCount');
        updateTokenDisplay();
        addResult('Token Refresh', 'SUCCESS', 'Token refreshed successfully');
    } catch (error) {
        incrementStat('errorCount');
        addResult('Token Refresh', 'ERROR', error.message);
    }
}

async function validateCurrentToken() {
    try {
        incrementStat('requestCount');
        const response = await fetch('/api/v1/csrf-token/validate', {
            method: 'POST',
            headers: {
                'X-CSRFToken': window.labAPI.csrfToken,
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (response.ok) {
            incrementStat('successCount');
            addResult('Token Validation', 'SUCCESS', result);
        } else {
            incrementStat('errorCount');
            addResult('Token Validation', 'FAILED', result);
        }
    } catch (error) {
        incrementStat('errorCount');
        addResult('Token Validation', 'ERROR', error.message);
    }
}

async function getTokenFromAPI() {
    try {
        incrementStat('requestCount');
        const response = await fetch('/api/v1/csrf-token');
        const data = await response.json();
        
        if (response.ok) {
            incrementStat('successCount');
            incrementStat('tokenCount');
            addResult('API Token Request', 'SUCCESS', `Token: ${data.csrf_token.substring(0, 20)}...`);
        } else {
            incrementStat('errorCount');
            addResult('API Token Request', 'FAILED', data);
        }
    } catch (error) {
        incrementStat('errorCount');
        addResult('API Token Request', 'ERROR', error.message);
    }
}

async function testWithoutToken() {
    try {
        incrementStat('requestCount');
        const response = await fetch('/csrf-test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({test_data: 'No CSRF token test'})
        });
        
        if (response.ok) {
            incrementStat('errorCount');
            addResult('No Token Test', 'UNEXPECTED SUCCESS', 'This should have failed!');
        } else {
            incrementStat('successCount');
            addResult('No Token Test', 'CORRECTLY BLOCKED', `Status: ${response.status}`);
        }
    } catch (error) {
        incrementStat('successCount');
        addResult('No Token Test', 'CORRECTLY BLOCKED', error.message);
    }
}

async function testWithInvalidToken() {
    try {
        incrementStat('requestCount');
        const response = await fetch('/csrf-test', {
            method: 'POST',
            headers: {
                'X-CSRFToken': 'invalid-fake-token-12345',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({test_data: 'Invalid CSRF token test'})
        });
        
        if (response.ok) {
            incrementStat('errorCount');
            addResult('Invalid Token Test', 'UNEXPECTED SUCCESS', 'This should have failed!');
        } else {
            incrementStat('successCount');
            addResult('Invalid Token Test', 'CORRECTLY BLOCKED', `Status: ${response.status}`);
        }
    } catch (error) {
        incrementStat('successCount');
        addResult('Invalid Token Test', 'CORRECTLY BLOCKED', error.message);
    }
}

async function testWithValidToken() {
    try {
        incrementStat('requestCount');
        const response = await window.labAPI.post('/csrf-test', {
            test_data: 'Valid CSRF token test'
        });
        
        if (response.ok) {
            incrementStat('successCount');
            const result = await response.json();
            addResult('Valid Token Test', 'SUCCESS', result);
        } else {
            incrementStat('errorCount');
            addResult('Valid Token Test', 'FAILED', `Status: ${response.status}`);
        }
    } catch (error) {
        incrementStat('errorCount');
        addResult('Valid Token Test', 'ERROR', error.message);
    }
}

function setupFormHandlers() {
    // Standard form
    document.getElementById('testForm1').addEventListener('submit', async function(e) {
        e.preventDefault();
        try {
            incrementStat('requestCount');
            const response = await window.labAPI.submitForm(this);
            if (response.ok) {
                incrementStat('successCount');
                const result = await response.json();
                addResult('Standard Form', 'SUCCESS', result);
            } else {
                incrementStat('errorCount');
                addResult('Standard Form', 'FAILED', `Status: ${response.status}`);
            }
        } catch (error) {
            incrementStat('errorCount');
            addResult('Standard Form', 'ERROR', error.message);
        }
    });
    
    // Upload form
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        try {
            incrementStat('requestCount');
            const response = await window.labAPI.submitForm(this);
            if (response.ok) {
                incrementStat('successCount');
                const result = await response.text();
                addResult('File Upload Form', 'SUCCESS', result);
            } else {
                incrementStat('errorCount');
                addResult('File Upload Form', 'FAILED', `Status: ${response.status}`);
            }
        } catch (error) {
            incrementStat('errorCount');
            addResult('File Upload Form', 'ERROR', error.message);
        }
    });
}

async function submitAjaxForm() {
    try {
        incrementStat('requestCount');
        const data = document.getElementById('ajaxData').value;
        const response = await window.labAPI.post('/csrf-test', {
            test_data: data,
            ajax_submit: true
        });
        
        if (response.ok) {
            incrementStat('successCount');
            const result = await response.json();
            addResult('AJAX Form', 'SUCCESS', result);
        } else {
            incrementStat('errorCount');
            addResult('AJAX Form', 'FAILED', `Status: ${response.status}`);
        }
    } catch (error) {
        incrementStat('errorCount');
        addResult('AJAX Form', 'ERROR', error.message);
    }
}

function addResult(testName, status, details) {
    const resultsDiv = document.getElementById('testResults');
    const timestamp = new Date().toLocaleTimeString();
    
    const statusClass = status === 'SUCCESS' ? 'success' : 
                       status === 'ERROR' ? 'error' : 
                       status === 'FAILED' ? 'error' : 'info';
    
    const resultHtml = `
        <div class="result-item ${statusClass} p-2 mb-2 rounded">
            <strong>[${timestamp}] ${testName}:</strong> 
            <span class="status">${status}</span>
            <div class="details mt-1 small">
                ${typeof details === 'object' ? JSON.stringify(details, null, 2) : details}
            </div>
        </div>
    `;
    
    resultsDiv.innerHTML += resultHtml;
    resultsDiv.scrollTop = resultsDiv.scrollHeight;
}

function clearResults() {
    document.getElementById('testResults').innerHTML = '<p class="text-muted">Test results will appear here...</p>';
}

function resetDemo() {
    stats = {tokenCount: 0, requestCount: 0, successCount: 0, errorCount: 0};
    updateStats();
    clearResults();
    updateTokenDisplay();
    addResult('Demo Reset', 'INFO', 'Demo has been reset');
}

async function runAllTests() {
    addResult('Automated Test Suite', 'INFO', 'Running all tests...');
    
    // Run tests in sequence
    await refreshToken();
    await validateCurrentToken();
    await getTokenFromAPI();
    await testWithoutToken();
    await testWithInvalidToken();
    await testWithValidToken();
    
    addResult('Automated Test Suite', 'COMPLETE', 'All automated tests completed');
}

function exportResults() {
    const results = document.getElementById('testResults').innerText;
    const blob = new Blob([results], {type: 'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `csrf-demo-results-${new Date().toISOString().split('T')[0]}.txt`;
    a.click();
    URL.revokeObjectURL(url);
}

// Additional test functions
async function getTokenFromUser() {
    return await getTokenFromEndpoint('/csrf-token', 'User Endpoint');
}

async function getTokenFromAdmin() {
    return await getTokenFromEndpoint('/admin/csrf-token', 'Admin Endpoint');
}

async function getTokenFromLab() {
    return await getTokenFromEndpoint('/lab/csrf-token', 'Lab Endpoint');
}

async function getTokenFromEndpoint(endpoint, name) {
    try {
        incrementStat('requestCount');
        const response = await fetch(endpoint);
        const data = await response.json();
        
        if (response.ok && data.csrf_token) {
            incrementStat('successCount');
            incrementStat('tokenCount');
            addResult(name, 'SUCCESS', `Token: ${data.csrf_token.substring(0, 20)}...`);
        } else {
            incrementStat('errorCount');
            addResult(name, 'FAILED', `Status: ${response.status}`);
        }
    } catch (error) {
        incrementStat('errorCount');
        addResult(name, 'ERROR', error.message);
    }
}

function expireToken() {
    window.labAPI.csrfToken = null;
    window.labAPI.csrfTokenTimestamp = null;
    updateTokenDisplay();
    addResult('Expire Token', 'INFO', 'Token cleared from memory (simulating expiry)');
}

async function testTokenReuse() {
    const originalToken = window.labAPI.csrfToken;
    
    // Make first request
    await testWithValidToken();
    
    // Try to reuse the same token (depending on implementation, this might work or fail)
    try {
        incrementStat('requestCount');
        const response = await fetch('/csrf-test', {
            method: 'POST',
            headers: {
                'X-CSRFToken': originalToken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({test_data: 'Token reuse test'})
        });
        
        if (response.ok) {
            incrementStat('successCount');
            addResult('Token Reuse Test', 'SUCCESS', 'Token was reusable (this may be expected)');
        } else {
            incrementStat('successCount');
            addResult('Token Reuse Test', 'BLOCKED', 'Token reuse was blocked (good security)');
        }
    } catch (error) {
        incrementStat('errorCount');
        addResult('Token Reuse Test', 'ERROR', error.message);
    }
}
</script>
{% endblock %}
